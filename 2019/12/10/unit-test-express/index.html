<!DOCTYPE html>
<html  lang="zh">
<head>
    <meta charset="utf-8" />

<meta name="generator" content="Hexo 4.2.0" />

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<title>unit test 是什麼? 又該如何在 express 開發上實作 unit test? - 技術雜記 Technology Notes - Jack Yu | 傑克</title>

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NKT99TP');</script>

<script data-ad-client="ca-pub-1515253208026743" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


    <meta name="description" content="前言 &lt;span style&#x3D;&quot;color:green&quot;&gt;[2019-12-22 Update]&lt;&#x2F;span&gt; 在express unit test 一些技巧教學以及困難點裡面有針對一些技巧做說明 以及增加測試涵蓋率的使用方式 在很久很久之前有提到過 unit test 但那時候只有針對簡單到不能在簡單的 function 進行 unit test 想必">
<meta property="og:type" content="article">
<meta property="og:title" content="unit test 是什麼? 又該如何在 express 開發上實作 unit test?">
<meta property="og:url" content="https://yu-jack.github.io/2019/12/10/unit-test-express/index.html">
<meta property="og:site_name" content="技術雜記 Technology Notes - Jack Yu | 傑克">
<meta property="og:description" content="前言 &lt;span style&#x3D;&quot;color:green&quot;&gt;[2019-12-22 Update]&lt;&#x2F;span&gt; 在express unit test 一些技巧教學以及困難點裡面有針對一些技巧做說明 以及增加測試涵蓋率的使用方式 在很久很久之前有提到過 unit test 但那時候只有針對簡單到不能在簡單的 function 進行 unit test 想必">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://yu-jack.github.io/images/og_image.png">
<meta property="article:published_time" content="2019-12-10T15:02:14.000Z">
<meta property="article:modified_time" content="2020-02-05T07:53:45.740Z">
<meta property="article:author" content="Jack Yu">
<meta property="article:tag" content="Test">
<meta property="article:tag" content="unit test">
<meta property="article:tag" content="sinon">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yu-jack.github.io/images/og_image.png">







<link rel="icon" href="/images/favicon.svg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-dark.css">

    
    
<style>body>.footer,body>.navbar,body>.section{opacity:0}</style>

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">

    
    
    
    
<link rel="stylesheet" href="/css/back-to-top.css">

    
    
    
    
    
    
    
    <link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
    
    
    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-2-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <!-- <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/logo.svg" alt="unit test 是什麼? 又該如何在 express 開發上實作 unit test?" height="28">
            
            </a>
        </div> -->
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">Home</a>
                
                <a class="navbar-item"
                href="/archives">Archives</a>
                
                <a class="navbar-item"
                href="/categories">Categories</a>
                
                <a class="navbar-item"
                href="/tags">Tags</a>
                
            </div>
            
            <div class="navbar-end">
                
                
                <a class="navbar-item is-hidden-tablet catalogue" title="文章目錄" href="javascript:;">
                    <i class="fas fa-list-ul"></i>
                </a>
                
                
                <a class="navbar-item search" title="搜尋" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-8-widescreen has-order-2 column-main">
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-12-10T15:02:14.000Z">2019-12-10</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Test/">Test</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    26 分鐘 閱讀文 (大約 3937 個字)
                </span>
                
                
                
                <span id="busuanzi_container_page_pv">
                    <span id="busuanzi_value_page_pv"></span> 觀看次數
                </span>
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                unit test 是什麼? 又該如何在 express 開發上實作 unit test?
            
        </h1>
        
            <div class="content">
                <h2><span id="前言">前言</span></h2>
<p>&lt;span style=&quot;color:green&quot;&gt;[2019-12-22 Update]&lt;/span&gt;
在<a href="https://yu-jack.github.io/2019/12/22/unit-test-express-implement-troubleshooting/">express unit test 一些技巧教學以及困難點</a>裡面有針對一些技巧做說明<br>
以及增加測試涵蓋率的使用方式</p>
<p>在很久很久之前有提到過 <a href="https://yu-jack.github.io/2017/11/01/how-to-test/">unit test</a><br>
但那時候只有針對簡單到不能在簡單的 function 進行 unit test<br>
想必大家一定也不太了解 unit test 究竟要怎麼用在真正開發上面</p>
<p>&lt;!-- more --&gt;</p>
<p>在真正開發上面要用到 unit test<br>
一定會牽扯到讀取資料庫、讀取檔案、呼叫 API 等等複雜邏輯<br>
難道在做測試的時候，我還要確保我的 API 可以呼叫<br>
資料庫可以進行連線等等後，我才能確認我的程式是否正確嗎?<br>
在這種情況下要做 unit test 真的是一件不簡單的事情<br>
更別說 test cases 跑到一半<br>
有人把你測試環境的 database 亂改動，或是 API  Server 的分支改掉這種鳥事了...</p>
<p>這樣的話，究竟要透過什麼樣的方式可以去做到 unit test 呢?<br>
其實可以透過 mock 的機制，讓呼叫 API 回傳值<br>
回傳一個固定值，而並不需要去真正呼叫 API</p>
<p>這裡所說的 mock 只是 unit test 使用到的一種方式<br>
其他還包含 spy 、stub、fake 等等
我們通常稱這些為 test double (測試替身)
以下會先介紹剛剛提到的 test double</p>
<blockquote>
<p>題外話，一開始看到這名詞讓我一直想到 JOJO ..</p>
</blockquote>
<h2><span id="test-double-測試替身">Test Double - 測試替身</span></h2>
<p>根據<a href="http://teddy-chen-tw.blogspot.com/2014/09/test-double2.html">搞笑談軟功</a>裡面其實有提到五種，但我這邊會介紹個人常見和常用到的四種</p>
<h3><span id="stub">stub</span></h3>
<p>當程式是使用到 HTTP 相關操作的，為了測試相依性降到最低
可以透過 stub 去變更發出 HTTP 程式的行為，變成不真的發出 HTTP，且可以自定義回傳的結果
還有包含讀檔的行為也是如此，利用 stub 取代真的讀檔的行為，使測試可以更關注在程式邏輯上面
而一般使用 stub 都會寫死回傳的資訊，以方便後續測試</p>
<p>使用情景: &lt;span style=&quot;color:green&quot;&gt;[假資料回傳]&lt;/span&gt;<br>
HTTP Request, 讀檔, 讀取資料庫等等，後續程式還沒實作的狀況下可以用來測試程式邏輯</p>
<h3><span id="spy">spy</span></h3>
<p>此 double 是用在去紀錄 function 的行為驗證上面
被 spy 的 function 就像是被安插間諜一樣，會去收集行為
function 也會真的被執行，並不會像 stub 一樣被取代掉
以 function 裡面 post http 為例，此 post http 是會真的發送請求出去，但會被紀錄
如果是用 stub 的話，post http 則是不會發送請求出去</p>
<p>使用情景: &lt;span style=&quot;color:green&quot;&gt;[行為驗證]&lt;/span&gt;<br>
因為程式是真的會執行，所以會專注在驗證程式執行的行為驗證上，例如驗證程式應該只能跑一次等等的行為上</p>
<p>想了解更詳細的可以讀讀 Sinon.js 的文件內容，擷取部分原文如下</p>
<blockquote>
<p>A test spy is a function that records arguments, return value, the
value of this and exception thrown (if any) for all its calls.
from <a href="https://sinonjs.org/releases/latest/spies/">Sinon Spy</a></p>
</blockquote>
<h3><span id="mock">mock</span></h3>
<p>Mock Object 則是類似於 spy 以及 stub 的集合體
本身擁有可以取代物件的方法 (stub)，且內建 expect 方法可以驗證執行的行為是否正確 (spy)
如果只是單純要讓後續程式邏輯接受固定值的話，用 stub 即可
如果只是單純要驗證程式的行為，用 spy 即可
但如果是以上兩個混合的狀況下，則是建議使用 Mock</p>
<p>使用情景: &lt;span style=&quot;color:green&quot;&gt;[行為驗證,假資料回傳]&lt;/span&gt;<br>
當需要驗證 HTTP POST 是否有根據所需參數進行執行，但又不想要真的發出 HTTP 的時候可以使用，跟 spy 最大差別在於 spy 是會真的執行程式，但 Mock 是不會真的去執行</p>
<p>想了解更詳細的可以讀讀 Sinon.js 的文件內容，擷取部分原文如下</p>
<blockquote>
<p>Mocks (and mock expectations) are fake methods (like spies) with pre-programmed behavior (like stubs) as well as pre-programmed expectations.
Mocks should only be used for the method under test. In every unit test, there should be one unit under test.
In general you should have no more than one mock (possibly with several expectations) in a single test.
from <a href="https://sinonjs.org/releases/latest/mocks/">Sinon Mock</a></p>
</blockquote>
<h3><span id="fake">fake</span></h3>
<p>此物件並不像是 spy 或是 stub 會取代程式裡面的行為
而是建立一個實際可執行的 function，通常是用在建立 XHR or Server or Database 上面，但會是以更簡化的方式去實現
例如原本可能是一個寄信的程式，但因為寄信驗證這件事情本身不好處理
這邊可以做出一個 fake Object 是把寄信的訊息內容，改成寫檔，已達成寄信行為的驗證</p>
<p>使用情境：&lt;span style=&quot;color:green&quot;&gt;[簡化程式]&lt;/span&gt;<br>
簡化寄信，或是簡化 DB 連線改用 In-memory 的方式等等，目的就是要簡化 prodcution code 的複雜度</p>
<p>想了解更詳細的可以讀讀 Sinon.js 的文件內容，擷取部分原文如下</p>
<blockquote>
<p>the sinon.fake API knows only how to create fakes, and doesn’t concern itself with plugging them into the system under test.
To plug the fakes into the system under test, you can use the sinon.replace* methods.
from <a href="https://sinonjs.org/releases/latest/fakes/">Sinon Fake</a></p>
</blockquote>
<h3><span id="小結結語">小結結語</span></h3>
<p>要特別注意一件事情<br>
每一個測試框架針對這些 test double 可能會有一些些微的差距<br>
最好是針對測試框架裡面的文件進行閱讀<br>
去了解使用時機跟方式會比較恰當<br>
接下來就開始介紹關於 Sinon 這個測試框架的程式實作部分<br>
以及該如何搭配 express 進行 unit test</p>
<h2><span id="實作">實作</span></h2>
<p>接下來會透過 express 搭配 sinon 進行 unit test 的說明<br>
首先我們會需要一個簡單的 express server<br>
此 server 功能有呼叫登入 API 以及寫檔兩種功能</p>
<p>為了方便進行 unit test 程式架構上，會進行拆分以模擬真實開發狀況<br>
登入的主要邏輯很單純<br>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server.js - listen 在 7070</span></span><br><span class="line"><span class="keyword">const</span> authController = <span class="built_in">require</span>(<span class="string">"./authController"</span>)</span><br><span class="line">app.post(<span class="string">"/login"</span>, authController.run);</span><br><span class="line"></span><br><span class="line"><span class="comment">// authController.js</span></span><br><span class="line"><span class="keyword">const</span> run = <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        username</span><br><span class="line">    &#125; = &#123;...req.body&#125;;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> apiService.login(username)</span><br><span class="line">    <span class="keyword">if</span> (result.status !== <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.json(&#123;</span><br><span class="line">            message: <span class="string">"登入失敗"</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res.json(&#123;</span><br><span class="line">        message: <span class="string">"登入成功"</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// apiService.js</span></span><br><span class="line"><span class="keyword">const</span> login = <span class="function">(<span class="params">username</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> axios.post(<span class="string">"http://localhost:7070/api"</span>, &#123;</span><br><span class="line">        username,</span><br><span class="line">    &#125;).then(<span class="function">(<span class="params">res</span>) =&gt;</span> res.data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 給 /login 用的, 不在測試範圍內</span></span><br><span class="line">app.post(<span class="string">"/api"</span>, (req, res) =&gt; &#123;</span><br><span class="line">    res.json(&#123;<span class="attr">status</span>: req.body.username === <span class="string">"123"</span> ? <span class="number">0</span> : <span class="number">1</span>&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>在這種情況下要進行 unit test 必須要確保<br>
呼叫 <code>apiService.login</code> 是不會有任何問題的<br>
那如果要移除這層依賴，透過 test double 該如何對 <code>authController.run</code> 進行測試呢?</p>
<h3><span id="express-with-sinon-stub">Express with Sinon Stub</span></h3>
<h4><span id="sinon-stub-介紹">Sinon Stub 介紹</span></h4>
<p>先介紹一下 Sinon Stub 如何使用，先看 code</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">"sinon"</span>);</span><br><span class="line"><span class="keyword">const</span> test = sinon.stub().returns(<span class="number">5</span>);</span><br><span class="line"><span class="built_in">console</span>.log(test());</span><br><span class="line"><span class="comment">// 5</span></span><br></pre></td></tr></table></figure>
透過 stub 這個 function 接到的回傳值會是一個 function<br>
而這個 function 可以自定義呼叫的時候會有什麼樣的行為<br>
上面的範例中，我們讓他呼叫後得到的回傳是 5</p>
<p>那如果要得到類似 <code>{status: 0}</code> 這種結果呢? 方法如下<br>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> test = sinon.stub().returns(&#123;<span class="attr">status</span>: <span class="number">0</span>&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(test());</span><br><span class="line"><span class="comment">// &#123;status: 0&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>那如果說是要取代原本 function 的功能呢?
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">"sinon"</span>);</span><br><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    test: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"this is test."</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(obj.test());</span><br><span class="line"><span class="comment">// "this is test."</span></span><br><span class="line">sinon.stub(obj, <span class="string">"test"</span>).resolves(&#123;<span class="attr">status</span>: <span class="number">0</span>&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(obj.test());</span><br><span class="line"><span class="comment">// Promise &#123; &#123; status: 0 &#125; &#125;</span></span><br></pre></td></tr></table></figure></p>
<p>透過以上方法，obj 裡面的 test function 就被取代掉<br>
然後讓這個 function 回傳一個 promise.resolve 的結果</p>
<p>但如果說我的 function 要接收一個參數，然後指定回傳呢?<br>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">"sinon"</span>);</span><br><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    test: <span class="function"><span class="keyword">function</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"this is test: "</span> + a</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(obj.test(<span class="string">"test"</span>));</span><br><span class="line"><span class="comment">// this is test: test</span></span><br><span class="line">sinon.stub(obj, <span class="string">"test"</span>).withArgs(<span class="string">"123"</span>).returns(&#123;<span class="attr">status</span>: <span class="number">0</span>&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(obj.test(<span class="string">"123"</span>));</span><br><span class="line"><span class="comment">// &#123; status: 0 &#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(obj.test());</span><br><span class="line"><span class="comment">// undefined</span></span><br></pre></td></tr></table></figure></p>
<p>透過 <code>withArgs</code> 可以設定，當這個 function 接收到什麼樣的參數的時候<br>
應該要回傳什麼樣的結果<br>
以上面的範例來說，只要這個 test function 的參數是 <code>&quot;123&quot;</code> 的話<br>
那他的回傳值就會是 <code>{ status: 0 }</code><br>
綜合以上的方法，就可以開始實作 unit test 了</p>
<h4><span id="如何在-express-上使用-stub">如何在 express 上使用 stub</span></h4>
<p>回到正題
因為是 express 的關係，所以 req 以及 res 的物件必須先透過 stub<br>
把 res 的行為先透過自訂義的方式給取代</p>
<blockquote>
<p>這邊 req 不用的原因是，我們只取 req.body 的值
所以可以直接當成 json 取值就好
但 res 不能的原因是, express 再回傳的時候
會需要多 call res.json() 來把值回傳回去</p>
</blockquote>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mockRequest = <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        body: data</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> mockResponse = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> res = &#123;&#125;;</span><br><span class="line">    res.json = sinon.stub().returns(res);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下來正式的測試程式來了<br>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">"[登入功能]"</span>, () =&gt; &#123;</span><br><span class="line">    it(<span class="string">"登入成功"</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> req = mockRequest(&#123;</span><br><span class="line">            username: <span class="string">"123"</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">const</span> res = mockResponse();</span><br><span class="line">        sinon.stub(apiService, <span class="string">"login"</span>).withArgs(<span class="string">"123"</span>).resolves(&#123;</span><br><span class="line">            status: <span class="number">0</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">await</span> authController.run(req, res)</span><br><span class="line">        sinon.assert.calledWith(res.json, &#123;</span><br><span class="line">            message: <span class="string">"登入成功"</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        sinon.assert.calledOnce(res.json);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>透過使用 <code>sinon.stub(apiService, &quot;login&quot;)</code><br>
可以把 apiService 裡面的 login function 實際行為給取消掉<br>
我們在後面定義了回傳一個 <code>Promise.resolve</code> 來指定被我們更改掉後應該回傳的資料<br>
也就是 <code>sinon.stub(apiService, &quot;login&quot;).resolves(data)</code> 裡面的 data<br>
這樣我們就可以讓 <code>authController.run</code> 裡面的 <code>apiService.login</code><br>
不會真正去發送 POST Request，而是會回傳我們的結果<br>
執行 mocha 後的結果如下<br>
<img src="/images/unit-test/mocha-1.png" alt></p>
<p>接下來我們再增加一個 test case，程式碼如下<br>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> apiServiceLogin = sinon.stub(apiService, <span class="string">"login"</span>)</span><br><span class="line">describe(<span class="string">"[登入功能]"</span>, () =&gt; &#123;</span><br><span class="line">    beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        apiServiceLogin.reset()</span><br><span class="line">    &#125;)</span><br><span class="line">    it(<span class="string">"登入成功"</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> req = mockRequest(&#123;</span><br><span class="line">            username: <span class="string">"123"</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">const</span> res = mockResponse();</span><br><span class="line">        apiServiceLogin.withArgs(<span class="string">"123"</span>).resolves(&#123;</span><br><span class="line">            status: <span class="number">0</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">await</span> authController.run(req, res)</span><br><span class="line">        sinon.assert.calledWith(res.json, &#123;</span><br><span class="line">            message: <span class="string">"登入成功"</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        sinon.assert.calledOnce(res.json);</span><br><span class="line">    &#125;)</span><br><span class="line">    it(<span class="string">"登入錯誤"</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> req = mockRequest(&#123;</span><br><span class="line">            username: <span class="string">"123"</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">const</span> res = mockResponse();</span><br><span class="line">        apiServiceLogin.withArgs(<span class="string">"123"</span>).resolves(&#123;</span><br><span class="line">            status: <span class="number">999</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">await</span> authController.run(req, res)</span><br><span class="line">        sinon.assert.calledWith(res.json, &#123;</span><br><span class="line">            message: <span class="string">"登入失敗"</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        sinon.assert.calledOnce(res.json);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>這邊要注意，已經被取代掉的 function，行為已經被我們第一個 test case 給固定了<br>
為了要還原預設行為，必須在 <code>beforeEach</code> 加上  <code>reset()</code> 的方法<br>
去重置每一個 test case <code>apiService.login</code> 回傳的行為，結果如下<br>
<img src="/images/unit-test/mocha-2.png" alt></p>
<h3><span id="express-with-sinon-spy">Express with Sinon Spy</span></h3>
<h4><span id="sinon-spy">Sinon Spy</span></h4>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">"sinon"</span>);</span><br><span class="line"><span class="keyword">const</span> spy = sinon.spy();</span><br><span class="line">spy()</span><br><span class="line"><span class="built_in">console</span>.log(spy.callCount);</span><br><span class="line"><span class="comment">// 1</span></span><br></pre></td></tr></table></figure></p>
<p>基本上所有測試替身呼叫後，都是會回傳一個可執行 function 回來<br>
根據前面介紹過，spy 是單純拿來做紀錄以及驗證<br>
上面的範例來說，就可以知道這個 function 被呼叫一次<br>
另外在 spy 的狀況下，function 實際行為是會被觸發，我們再來看另一段 code<br>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">"sinon"</span>);</span><br><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    test: <span class="function"><span class="keyword">function</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"this is test: "</span> + a</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> spy = sinon.spy(obj, <span class="string">"test"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(spy(<span class="string">"hihi"</span>));</span><br><span class="line"><span class="comment">// this is test: hihi</span></span><br><span class="line"><span class="built_in">console</span>.log(obj.test(<span class="string">"hihi2"</span>));</span><br><span class="line"><span class="comment">// this is test: hihi2</span></span><br><span class="line"><span class="built_in">console</span>.log(spy.callCount);</span><br><span class="line"><span class="comment">// 2</span></span><br></pre></td></tr></table></figure>
以上面的例子可以看到，程式實際上的邏輯是有被觸發成功的<br>
透過 spy 回傳的值，也是一個可執行的 function<br>
透過 <code>spy()</code> 或是 <code>obj.test()</code> 去觸發，都會被記錄起來</p>
<h4><span id="如何在-express-上使用-spy">如何在 express 上使用  spy</span></h4>
<p>程式碼會增加一段對 username 進行 hash 再去做 login<br>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// authControler.js</span></span><br><span class="line"><span class="keyword">const</span> run = <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        username</span><br><span class="line">    &#125; = &#123;...req.body&#125;;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> apiService.login(hash.sha256(username))</span><br><span class="line">    <span class="keyword">if</span> (result.status !== <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.json(&#123;</span><br><span class="line">            message: <span class="string">"登入失敗"</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res.json(&#123;</span><br><span class="line">        message: <span class="string">"登入成功"</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// hash.js</span></span><br><span class="line"><span class="keyword">const</span> sha256 = <span class="function">(<span class="params">username</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> t = ctypto.createHash(<span class="string">"sha256"</span>);</span><br><span class="line">    <span class="keyword">return</span> t.update(username, <span class="string">"utf8"</span>).digest(<span class="string">"base64"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>先來跑跑看 unit test 會發現結果是錯的<br>
原因是因為原本設定好 login 的時候，參數應該會是帶 <code>&quot;123&quot;</code><br>
但因為變成 hash 之後會改成 <code>&quot;pmWkWSBCL51Bfkhn79xPuKBKHz//H6B+mY6G9/eieuM=&quot;</code><br>
把 unit test 裡面的 withArgs 改成 <code>apiServiceLogin.withArgs(&quot;pmWkWSBCL51Bfkhn79xPuKBKHz//H6B+mY6G9/eieuM=&quot;)</code> 即可</p>
<p>此時我們想要針對 <code>hash.sha256</code> 進行次數監控<br>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hashSha256 = sinon.spy(hash, <span class="string">"sha256"</span>);</span><br><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        apiServiceLogin.reset()</span><br><span class="line">        hashSha256.resetHistory()</span><br><span class="line">    &#125;)</span><br><span class="line">    it(<span class="string">"登入成功, hash 一次"</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> req = mockRequest(&#123;</span><br><span class="line">            username: <span class="string">"123"</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">const</span> res = mockResponse();</span><br><span class="line">        apiServiceLogin.withArgs(<span class="string">"pmWkWSBCL51Bfkhn79xPuKBKHz//H6B+mY6G9/eieuM="</span>).resolves(&#123;</span><br><span class="line">            status: <span class="number">0</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">await</span> authController.run(req, res)</span><br><span class="line">        sinon.assert.calledWith(res.json, &#123;</span><br><span class="line">            message: <span class="string">"登入成功"</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        sinon.assert.calledOnce(res.json);</span><br><span class="line">        sinon.assert.calledOnce(hashSha256)</span><br><span class="line">    &#125;)</span><br><span class="line">    it(<span class="string">"登入錯誤, hash 一次"</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> req = mockRequest(&#123;</span><br><span class="line">            username: <span class="string">"123"</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">const</span> res = mockResponse();</span><br><span class="line">        apiServiceLogin.withArgs(<span class="string">"pmWkWSBCL51Bfkhn79xPuKBKHz//H6B+mY6G9/eieuM="</span>).resolves(&#123;</span><br><span class="line">            status: <span class="number">999</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">await</span> authController.run(req, res)</span><br><span class="line">        sinon.assert.calledWith(res.json, &#123;</span><br><span class="line">            message: <span class="string">"登入失敗"</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        sinon.assert.calledOnce(res.json);</span><br><span class="line">        sinon.assert.calledOnce(hashSha256)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure></p>
<p>先在最前面加上 <code>const hashSha256 = sinon.spy(hash, &quot;sha256&quot;);</code> 取完成 spy 的動作
然後在最後面加上了驗證 <code>sinon.assert.calledOnce(hashSha256)</code> 就可以完成驗證動作<br>
除此之外，要先在 <code>beforeEach</code> 加上 <code>hashSha256.resetHistory()</code> 去重置計算次數</p>
<h3><span id="express-with-sinon-mock">Express with Sinon Mock</span></h3>
<h4><span id="sinon-mock">Sinon Mock</span></h4>
<p>不同於 stub 以及 spy<br>
透過 mock 回傳的東西並不是一個可執行的 function<br>
而是要透過此 mock 去進行設定，類似『驗證』用的東西<br>
以及可以像是 stub 一樣，指定在 function 被呼叫的時候，應該會有什麼樣的回傳值<br>
但又不同於 stub 以及 spy，mock 並不能直接去針對某一個做 mock<br>
而是只能會對整個 obj 做 mock<br>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">"sinon"</span>);</span><br><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    test: <span class="function"><span class="keyword">function</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"this is test: "</span> + a</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> mock = sinon.mock(obj);</span><br><span class="line"><span class="comment">// 驗證只能最多被呼叫 2 次</span></span><br><span class="line">mock.expects(<span class="string">"test"</span>).atLeast(<span class="number">2</span>).returns(&#123;<span class="attr">status</span>: <span class="number">1</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(obj.test());</span><br><span class="line"><span class="comment">// &#123; status: 1 &#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(obj.test());</span><br><span class="line"><span class="comment">// &#123; status: 1 &#125;</span></span><br><span class="line"></span><br><span class="line">mock.verify()</span><br></pre></td></tr></table></figure></p>
<p>透過 <code>mock.expects(&quot;test&quot;).atLeast(2).returns({status: 1})</code> 去設定<br>
預期哪一個 method 應該回傳什麼樣的值以及設定可被執行的次數<br>
最後再透過 <code>mock.verify()</code> 可以啟用這個 assertion<br>
除此之外，如果想要回復這個被 mock 原始的 method 的話<br>
可以透過 <code>mock.restore()</code> 去做回覆的動作<br>
這樣回覆之後，就會執行原本 function 的邏輯了</p>
<h4><span id="如何在-express-上使用-mock">如何在 express 上使用 mock</span></h4>
<p>基本上程式碼跟上一個很像，但不一樣的地方在於<br>
我想要針對 apiService.js 去進行驗證，以及模擬回傳值<br>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> apiServiceLogin = sinon.mock(apiService);</span><br><span class="line">it(<span class="string">"登入成功, hash 一次"</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> req = mockRequest(&#123;</span><br><span class="line">            username: <span class="string">"123"</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">const</span> res = mockResponse();</span><br><span class="line">        apiServiceLogin.expects(<span class="string">"login"</span>).withArgs(<span class="string">"pmWkWSBCL51Bfkhn79xPuKBKHz//H6B+mY6G9/eieuM="</span>).resolves(&#123;</span><br><span class="line">            status: <span class="number">0</span></span><br><span class="line">        &#125;).once();</span><br><span class="line">        <span class="keyword">await</span> authController.run(req, res)</span><br><span class="line">        sinon.assert.calledWith(res.json, &#123;</span><br><span class="line">            message: <span class="string">"登入成功"</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        sinon.assert.calledOnce(res.json);</span><br><span class="line">        sinon.assert.calledOnce(hashSha256)</span><br><span class="line">    &#125;)</span><br><span class="line">    it(<span class="string">"登入錯誤, hash 一次"</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> req = mockRequest(&#123;</span><br><span class="line">            username: <span class="string">"123"</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">const</span> res = mockResponse();</span><br><span class="line">        apiServiceLogin.expects(<span class="string">"login"</span>).withArgs(<span class="string">"pmWkWSBCL51Bfkhn79xPuKBKHz//H6B+mY6G9/eieuM="</span>).resolves(&#123;</span><br><span class="line">            status: <span class="number">-1</span></span><br><span class="line">        &#125;).once();</span><br><span class="line">        <span class="keyword">await</span> authController.run(req, res)</span><br><span class="line">        sinon.assert.calledWith(res.json, &#123;</span><br><span class="line">            message: <span class="string">"登入失敗"</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        sinon.assert.calledOnce(res.json);</span><br><span class="line">        sinon.assert.calledOnce(hashSha256)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure></p>
<p>差別在於以下程式，透過 mock，可以去指定回傳值，以及可以兼顧驗證用的功能
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apiServiceLogin.expects(<span class="string">"login"</span>).withArgs(<span class="string">"pmWkWSBCL51Bfkhn79xPuKBKHz//H6B+mY6G9/eieuM="</span>).resolves(&#123;</span><br><span class="line">    status: <span class="number">-1</span></span><br><span class="line">&#125;).once();</span><br></pre></td></tr></table></figure></p>
<h3><span id="express-with-sinon-fake">Express with Sinon Fake</span></h3>
<h4><span id="sinon-fake">Sinon Fake</span></h4>
<p>在 Sinon 官網上對於 Fake 的說明是<br>
一種把 spy 跟 stub 混合的一種形式<br>
所以這邊後面並不會介紹如何在 express 上面實作<br>
而是會針對這個 fake 功能做些簡單的範例而已</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">"sinon"</span>);</span><br><span class="line"><span class="keyword">const</span> fake = sinon.fake.returns(&#123;<span class="attr">status</span>: <span class="number">1</span>&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(fake());</span><br><span class="line">&#123; <span class="attr">status</span>: <span class="number">1</span> &#125;</span><br></pre></td></tr></table></figure></p>
<p>跟 stub 一樣可以指定該 function 應該回傳的值<br>
但他也有可以取代原本 method 的功能，程式如下</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">"sinon"</span>);</span><br><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    test: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"test"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> fake = sinon.fake.returns(&#123;<span class="attr">status</span>: <span class="number">1</span>&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(obj.test());</span><br><span class="line"><span class="comment">// test</span></span><br><span class="line">sinon.replace(obj, <span class="string">"test"</span>, fake)</span><br><span class="line"><span class="built_in">console</span>.log(obj.test());</span><br><span class="line"><span class="comment">// &#123; status: 1 &#125;</span></span><br></pre></td></tr></table></figure></p>
<p>透過 <code>sinon.replace</code>，可以取代掉原本 function 的實際邏輯</p>
<h2><span id="結語">結語</span></h2>
<p>以上介紹完每一個 test double 的意思以及使用場景<br>
但使用場景上，我也還在思考什麼樣的場景可以搭配什麼去使用<br>
歡迎各位一起在下面留言進行討論<br>
未來會再針對實務上 unit test 遇到的困難再回來整理一篇</p>
<h2><span id="references">References</span></h2>
<ol>
<li>https://www.sitepoint.com/sinon-tutorial-javascript-testing-mocks-spies-stubs/</li>
<li>https://dev.to/milipski/test-doubles---fakes-mocks-and-stubs</li>
<li>https://codewithhugo.com/express-request-response-mocking/</li>
<li>https://tpu.thinkpower.com.tw/tpu/articleDetails/1294</li>
<li>http://kaczanowscy.pl/tomek/2011-01/testing-basics-sut-and-docs</li>
</ol>

            </div>
        
        
        <div class="level is-size-7 is-uppercase">
            <div class="level-start">
                <div class="level-item">
                    <span class="is-size-6 has-text-grey has-mr-7">#</span>
                    <a class="has-link-grey -link" href="/tags/Test/" rel="tag">Test</a>, <a class="has-link-grey -link" href="/tags/sinon/" rel="tag">sinon</a>, <a class="has-link-grey -link" href="/tags/unit-test/" rel="tag">unit test</a>
                </div>
            </div>
        </div>
        
        
        
    </div>
</div>





<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/2019/12/22/unit-test-express-implement-troubleshooting/">
                <i class="level-item fas fa-chevron-left"></i>
                <span class="level-item">express unit test 一些技巧教學以及困難點</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/2019/11/28/aws-cloudwatch-logs-insights/">
                <span class="level-item">AWS CloudWatch Logs Insights 介紹及教學</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="title is-5 has-text-weight-normal">評論</h3>
        
<script>
    var disqus_config = function () {
        this.page.url = 'https://yu-jack.github.io/2019/12/10/unit-test-express/';
        this.page.identifier = '2019/12/10/unit-test-express/';
    };
    (function() {
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'yu-jack' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

<div id="disqus_thread">
    
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
    </div>
</div>
</div>
                





<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left is-sticky">
    
        
    
        
            

    <div class="card widget" id="toc">
        <div class="card-content">
            <div class="menu">
                <h3 class="menu-label">
                    文章目錄
                </h3>
                <ul class="menu-list"><li>
        <a class="is-flex" href="#前言">
        <span class="has-mr-6">1</span>
        <span>前言</span>
        </a></li><li>
        <a class="is-flex" href="#test-double-測試替身">
        <span class="has-mr-6">2</span>
        <span>Test Double - 測試替身</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#stub">
        <span class="has-mr-6">2.1</span>
        <span>stub</span>
        </a></li><li>
        <a class="is-flex" href="#spy">
        <span class="has-mr-6">2.2</span>
        <span>spy</span>
        </a></li><li>
        <a class="is-flex" href="#mock">
        <span class="has-mr-6">2.3</span>
        <span>mock</span>
        </a></li><li>
        <a class="is-flex" href="#fake">
        <span class="has-mr-6">2.4</span>
        <span>fake</span>
        </a></li><li>
        <a class="is-flex" href="#小結結語">
        <span class="has-mr-6">2.5</span>
        <span>小結結語</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#實作">
        <span class="has-mr-6">3</span>
        <span>實作</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#express-with-sinon-stub">
        <span class="has-mr-6">3.1</span>
        <span>Express with Sinon Stub</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#sinon-stub-介紹">
        <span class="has-mr-6">3.1.1</span>
        <span>Sinon Stub 介紹</span>
        </a></li><li>
        <a class="is-flex" href="#如何在-express-上使用-stub">
        <span class="has-mr-6">3.1.2</span>
        <span>如何在 express 上使用 stub</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#express-with-sinon-spy">
        <span class="has-mr-6">3.2</span>
        <span>Express with Sinon Spy</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#sinon-spy">
        <span class="has-mr-6">3.2.1</span>
        <span>Sinon Spy</span>
        </a></li><li>
        <a class="is-flex" href="#如何在-express-上使用-spy">
        <span class="has-mr-6">3.2.2</span>
        <span>如何在 express 上使用  spy</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#express-with-sinon-mock">
        <span class="has-mr-6">3.3</span>
        <span>Express with Sinon Mock</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#sinon-mock">
        <span class="has-mr-6">3.3.1</span>
        <span>Sinon Mock</span>
        </a></li><li>
        <a class="is-flex" href="#如何在-express-上使用-mock">
        <span class="has-mr-6">3.3.2</span>
        <span>如何在 express 上使用 mock</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#express-with-sinon-fake">
        <span class="has-mr-6">3.4</span>
        <span>Express with Sinon Fake</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#sinon-fake">
        <span class="has-mr-6">3.4.1</span>
        <span>Sinon Fake</span>
        </a></li></ul></li></ul></li><li>
        <a class="is-flex" href="#結語">
        <span class="has-mr-6">4</span>
        <span>結語</span>
        </a></li><li>
        <a class="is-flex" href="#references">
        <span class="has-mr-6">5</span>
        <span>References</span>
        </a></li></ul>
            </div>
        </div>
    </div>

        
    
        
    
        
    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
            
        
        </div>
    
</div>


                





<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-3 column-right ">
    
        
    
    
</div>


            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <p class="is-size-7">
                &copy; 2020 Jack Yu&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a> & Jack Yu
                
                </p>
            </div>
            <div class="level-end">
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-TW");</script>


<script>
var IcarusThemeSettings = {
    site: {
        url: 'https://yu-jack.github.io',
        external_link: {"enable":true,"exclude":[]}
    },
    article: {
        highlight: {
            clipboard: true,
            fold: 'unfolded'
        }
    }
};
</script>


<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>





<script src="/js/animation.js"></script>



<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
<script src="/js/gallery.js" defer></script>



<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>


<a id="back-to-top" title="回到頁首" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>














<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="請輸入關鍵字..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '頁面',
                CATEGORIES: '分類',
                TAGS: '標籤',
                UNTITLED: '(無標題)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</body>
</html>