<!DOCTYPE html>
<html lang="en">

<canvas id="fireworks" style="position: fixed"></canvas>
<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="GfJLBEu3BHvdazYMXsGETTsY_cx2FLLXrqcx0H0s4cA" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/ironman-draw.png">
    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.5/dist/medium-zoom.min.js"></script>
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-NKT99TP');</script>
    <!-- End Google Tag Manager -->

    <title>
        
          unit test 是什麼? 又該如何在 express 開發上實作 unit test? - Jack Yu | 傑克
        
    </title>

    <link rel="canonical" href="https://yu-jack.github.io/2019/12/10/unit-test-express/">

    <!-- Bootstrap Core CSS -->
    
<link rel="stylesheet" href="/css/bootstrap.min.css">


    <!-- Custom CSS --> 
    
<link rel="stylesheet" href="/css/beantech.min.css">

    
    <!-- Pygments Highlight CSS -->
    
<link rel="stylesheet" href="/css/highlight.css">


    
<link rel="stylesheet" href="/css/widget.css">


    
<link rel="stylesheet" href="/css/rocket.css">


    
<link rel="stylesheet" href="/css/signature.css">


    
<link rel="stylesheet" href="/css/toc.css">


    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>

    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1515253208026743",
        enable_page_level_ads: true
      });
    </script>
    <style>
        img {
            border: 1px solid #00000042;
            box-shadow: 1px 1px 5px;
        }
        div.post-container h2:not(.post-title) {
            border-bottom: 2px solid #eee;
            padding-bottom: 0.3em;
        }
        div.post-container h1:not(.post-title) {
            border-bottom: 2px solid #eee;
            padding-bottom: 0.3em;
        }
    </style>
    <style>
      .medium-zoom-overlay {
        z-index: 5;
      }
      .medium-zoom-image {
        z-index: 10;
      }
    </style>
<meta name="generator" content="Hexo 4.2.0"></head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            background-image: url('/images/banner.jpg')
            /*post*/
        
    }
    
</style>

<header class="intro-header" >
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#Test" title="Test">Test</a>
                            
                              <a class="tag" href="/tags/#unit test" title="unit test">unit test</a>
                            
                              <a class="tag" href="/tags/#sinon" title="sinon">sinon</a>
                            
                        </div>
                        <h1>unit test 是什麼? 又該如何在 express 開發上實作 unit test?</h1>
                        <h2 class="subheading"></h2>
                        <span class="meta">
                            Posted by Jack Yu on
                            2019-12-10
                        </span>
                        <span id="busuanzi_container_page_pv">
                            <span id="busuanzi_value_page_pv"></span> views,
                        </span>
                        <span class="post-count">4k words,</span>
                        <span class="post-read-time">17 min read</span>
                    </div>
                


                </div>
            </div>
        </div>
    </div>
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">技術雜記 Technology Notes</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">All Tags</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Modify by Yu-Hsuan Yen -->

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h2><span id="前言">前言</span></h2><p><span style="color:green">[2019-12-22 Update]</span><br>在<a href="https://yu-jack.github.io/2019/12/22/unit-test-express-implement-troubleshooting/">express unit test 一些技巧教學以及困難點</a>裡面有針對一些技巧做說明<br>以及增加測試涵蓋率的使用方式</p>
<p>在很久很久之前有提到過 <a href="https://yu-jack.github.io/2017/11/01/how-to-test/">unit test</a><br>但那時候只有針對簡單到不能在簡單的 function 進行 unit test<br>想必大家一定也不太了解 unit test 究竟要怎麼用在真正開發上面  </p>
<a id="more"></a>
<p>在真正開發上面要用到 unit test<br>一定會牽扯到讀取資料庫、讀取檔案、呼叫 API 等等複雜邏輯<br>難道在做測試的時候，我還要確保我的 API 可以呼叫<br>資料庫可以進行連線等等後，我才能確認我的程式是否正確嗎?<br>在這種情況下要做 unit test 真的是一件不簡單的事情<br>更別說 test cases 跑到一半<br>有人把你測試環境的 database 亂改動，或是 API  Server 的分支改掉這種鳥事了…  </p>
<p>這樣的話，究竟要透過什麼樣的方式可以去做到 unit test 呢?<br>其實可以透過 mock 的機制，讓呼叫 API 回傳值<br>回傳一個固定值，而並不需要去真正呼叫 API  </p>
<p>這裡所說的 mock 只是 unit test 使用到的一種方式<br>其他還包含 spy 、stub、fake 等等<br>我們通常稱這些為 test double (測試替身)<br>以下會先介紹剛剛提到的 test double</p>
<blockquote>
<p>題外話，一開始看到這名詞讓我一直想到 JOJO .. </p>
</blockquote>
<h2><span id="test-double-測試替身">Test Double - 測試替身</span></h2><p>根據<a href="http://teddy-chen-tw.blogspot.com/2014/09/test-double2.html" target="_blank" rel="noopener">搞笑談軟功</a>裡面其實有提到五種，但我這邊會介紹個人常見和常用到的四種</p>
<h3><span id="stub">stub</span></h3><p>當程式是使用到 HTTP 相關操作的，為了測試相依性降到最低<br>可以透過 stub 去變更發出 HTTP 程式的行為，變成不真的發出 HTTP，且可以自定義回傳的結果<br>還有包含讀檔的行為也是如此，利用 stub 取代真的讀檔的行為，使測試可以更關注在程式邏輯上面<br>而一般使用 stub 都會寫死回傳的資訊，以方便後續測試</p>
<p>使用情景: <span style="color:green">[假資料回傳]</span><br>HTTP Request, 讀檔, 讀取資料庫等等，後續程式還沒實作的狀況下可以用來測試程式邏輯</p>
<h3><span id="spy">spy</span></h3><p>此 double 是用在去紀錄 function 的行為驗證上面<br>被 spy 的 function 就像是被安插間諜一樣，會去收集行為<br>function 也會真的被執行，並不會像 stub 一樣被取代掉<br>以 function 裡面 post http 為例，此 post http 是會真的發送請求出去，但會被紀錄<br>如果是用 stub 的話，post http 則是不會發送請求出去</p>
<p>使用情景: <span style="color:green">[行為驗證]</span><br>因為程式是真的會執行，所以會專注在驗證程式執行的行為驗證上，例如驗證程式應該只能跑一次等等的行為上  </p>
<p>想了解更詳細的可以讀讀 Sinon.js 的文件內容，擷取部分原文如下  </p>
<blockquote>
<p>A test spy is a function that records arguments, return value, the<br>value of this and exception thrown (if any) for all its calls.<br>from <a href="https://sinonjs.org/releases/latest/spies/" target="_blank" rel="noopener">Sinon Spy</a></p>
</blockquote>
<h3><span id="mock">mock</span></h3><p>Mock Object 則是類似於 spy 以及 stub 的集合體<br>本身擁有可以取代物件的方法 (stub)，且內建 expect 方法可以驗證執行的行為是否正確 (spy)<br>如果只是單純要讓後續程式邏輯接受固定值的話，用 stub 即可<br>如果只是單純要驗證程式的行為，用 spy 即可<br>但如果是以上兩個混合的狀況下，則是建議使用 Mock </p>
<p>使用情景: <span style="color:green">[行為驗證,假資料回傳]</span><br>當需要驗證 HTTP POST 是否有根據所需參數進行執行，但又不想要真的發出 HTTP 的時候可以使用，跟 spy 最大差別在於 spy 是會真的執行程式，但 Mock 是不會真的去執行</p>
<p>想了解更詳細的可以讀讀 Sinon.js 的文件內容，擷取部分原文如下    </p>
<blockquote>
<p>Mocks (and mock expectations) are fake methods (like spies) with pre-programmed behavior (like stubs) as well as pre-programmed expectations.<br>Mocks should only be used for the method under test. In every unit test, there should be one unit under test.<br>In general you should have no more than one mock (possibly with several expectations) in a single test.<br>from <a href="https://sinonjs.org/releases/latest/mocks/" target="_blank" rel="noopener">Sinon Mock</a></p>
</blockquote>
<h3><span id="fake">fake</span></h3><p>此物件並不像是 spy 或是 stub 會取代程式裡面的行為<br>而是建立一個實際可執行的 function，通常是用在建立 XHR or Server or Database 上面，但會是以更簡化的方式去實現<br>例如原本可能是一個寄信的程式，但因為寄信驗證這件事情本身不好處理<br>這邊可以做出一個 fake Object 是把寄信的訊息內容，改成寫檔，已達成寄信行為的驗證</p>
<p>使用情境：<span style="color:green">[簡化程式]</span><br>簡化寄信，或是簡化 DB 連線改用 In-memory 的方式等等，目的就是要簡化 prodcution code 的複雜度</p>
<p>想了解更詳細的可以讀讀 Sinon.js 的文件內容，擷取部分原文如下    </p>
<blockquote>
<p>the sinon.fake API knows only how to create fakes, and doesn’t concern itself with plugging them into the system under test.<br>To plug the fakes into the system under test, you can use the sinon.replace* methods.<br>from <a href="https://sinonjs.org/releases/latest/fakes/" target="_blank" rel="noopener">Sinon Fake</a>  </p>
</blockquote>
<h3><span id="小結結語">小結結語</span></h3><p>要特別注意一件事情<br>每一個測試框架針對這些 test double 可能會有一些些微的差距<br>最好是針對測試框架裡面的文件進行閱讀<br>去了解使用時機跟方式會比較恰當<br>接下來就開始介紹關於 Sinon 這個測試框架的程式實作部分<br>以及該如何搭配 express 進行 unit test  </p>
<h2><span id="實作">實作</span></h2><p>接下來會透過 express 搭配 sinon 進行 unit test 的說明<br>首先我們會需要一個簡單的 express server<br>此 server 功能有呼叫登入 API 以及寫檔兩種功能  </p>
<p>為了方便進行 unit test 程式架構上，會進行拆分以模擬真實開發狀況<br>登入的主要邏輯很單純<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server.js - listen 在 7070</span></span><br><span class="line"><span class="keyword">const</span> authController = <span class="built_in">require</span>(<span class="string">"./authController"</span>)</span><br><span class="line">app.post(<span class="string">"/login"</span>, authController.run);</span><br><span class="line"></span><br><span class="line"><span class="comment">// authController.js</span></span><br><span class="line"><span class="keyword">const</span> run = <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        username</span><br><span class="line">    &#125; = &#123;...req.body&#125;;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> apiService.login(username)</span><br><span class="line">    <span class="keyword">if</span> (result.status !== <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.json(&#123;</span><br><span class="line">            message: <span class="string">"登入失敗"</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res.json(&#123;</span><br><span class="line">        message: <span class="string">"登入成功"</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// apiService.js</span></span><br><span class="line"><span class="keyword">const</span> login = <span class="function">(<span class="params">username</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> axios.post(<span class="string">"http://localhost:7070/api"</span>, &#123;</span><br><span class="line">        username,</span><br><span class="line">    &#125;).then(<span class="function">(<span class="params">res</span>) =&gt;</span> res.data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 給 /login 用的, 不在測試範圍內</span></span><br><span class="line">app.post(<span class="string">"/api"</span>, (req, res) =&gt; &#123;</span><br><span class="line">    res.json(&#123;<span class="attr">status</span>: req.body.username === <span class="string">"123"</span> ? <span class="number">0</span> : <span class="number">1</span>&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>在這種情況下要進行 unit test 必須要確保<br>呼叫 <code>apiService.login</code> 是不會有任何問題的<br>那如果要移除這層依賴，透過 test double 該如何對 <code>authController.run</code> 進行測試呢?  </p>
<h3><span id="express-with-sinon-stub">Express with Sinon Stub</span></h3><h4><span id="sinon-stub-介紹">Sinon Stub 介紹</span></h4><p>先介紹一下 Sinon Stub 如何使用，先看 code</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">"sinon"</span>);</span><br><span class="line"><span class="keyword">const</span> test = sinon.stub().returns(<span class="number">5</span>);</span><br><span class="line"><span class="built_in">console</span>.log(test());</span><br><span class="line"><span class="comment">// 5</span></span><br></pre></td></tr></table></figure>
<p>透過 stub 這個 function 接到的回傳值會是一個 function<br>而這個 function 可以自定義呼叫的時候會有什麼樣的行為<br>上面的範例中，我們讓他呼叫後得到的回傳是 5  </p>
<p>那如果要得到類似 <code>{status: 0}</code> 這種結果呢? 方法如下<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> test = sinon.stub().returns(&#123;<span class="attr">status</span>: <span class="number">0</span>&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(test());</span><br><span class="line"><span class="comment">// &#123;status: 0&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>那如果說是要取代原本 function 的功能呢?<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">"sinon"</span>);</span><br><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    test: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"this is test."</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(obj.test());</span><br><span class="line"><span class="comment">// "this is test."</span></span><br><span class="line">sinon.stub(obj, <span class="string">"test"</span>).resolves(&#123;<span class="attr">status</span>: <span class="number">0</span>&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(obj.test());</span><br><span class="line"><span class="comment">// Promise &#123; &#123; status: 0 &#125; &#125;</span></span><br></pre></td></tr></table></figure></p>
<p>透過以上方法，obj 裡面的 test function 就被取代掉<br>然後讓這個 function 回傳一個 promise.resolve 的結果  </p>
<p>但如果說我的 function 要接收一個參數，然後指定回傳呢?<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">"sinon"</span>);</span><br><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    test: <span class="function"><span class="keyword">function</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"this is test: "</span> + a</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(obj.test(<span class="string">"test"</span>));</span><br><span class="line"><span class="comment">// this is test: test</span></span><br><span class="line">sinon.stub(obj, <span class="string">"test"</span>).withArgs(<span class="string">"123"</span>).returns(&#123;<span class="attr">status</span>: <span class="number">0</span>&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(obj.test(<span class="string">"123"</span>));</span><br><span class="line"><span class="comment">// &#123; status: 0 &#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(obj.test());</span><br><span class="line"><span class="comment">// undefined</span></span><br></pre></td></tr></table></figure></p>
<p>透過 <code>withArgs</code> 可以設定，當這個 function 接收到什麼樣的參數的時候<br>應該要回傳什麼樣的結果<br>以上面的範例來說，只要這個 test function 的參數是 <code>&quot;123&quot;</code> 的話<br>那他的回傳值就會是 <code>{ status: 0 }</code><br>綜合以上的方法，就可以開始實作 unit test 了  </p>
<h4><span id="如何在-express-上使用-stub">如何在 express 上使用 stub</span></h4><p>回到正題<br>因為是 express 的關係，所以 req 以及 res 的物件必須先透過 stub<br>把 res 的行為先透過自訂義的方式給取代  </p>
<blockquote>
<p>這邊 req 不用的原因是，我們只取 req.body 的值<br>所以可以直接當成 json 取值就好<br>但 res 不能的原因是, express 再回傳的時候<br>會需要多 call res.json() 來把值回傳回去  </p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mockRequest = <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        body: data</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> mockResponse = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> res = &#123;&#125;;</span><br><span class="line">    res.json = sinon.stub().returns(res);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下來正式的測試程式來了<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">"[登入功能]"</span>, () =&gt; &#123;</span><br><span class="line">    it(<span class="string">"登入成功"</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> req = mockRequest(&#123;</span><br><span class="line">            username: <span class="string">"123"</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">const</span> res = mockResponse();</span><br><span class="line">        sinon.stub(apiService, <span class="string">"login"</span>).withArgs(<span class="string">"123"</span>).resolves(&#123;</span><br><span class="line">            status: <span class="number">0</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">await</span> authController.run(req, res)</span><br><span class="line">        sinon.assert.calledWith(res.json, &#123;</span><br><span class="line">            message: <span class="string">"登入成功"</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        sinon.assert.calledOnce(res.json);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>透過使用 <code>sinon.stub(apiService, &quot;login&quot;)</code><br>可以把 apiService 裡面的 login function 實際行為給取消掉<br>我們在後面定義了回傳一個 <code>Promise.resolve</code> 來指定被我們更改掉後應該回傳的資料<br>也就是 <code>sinon.stub(apiService, &quot;login&quot;).resolves(data)</code> 裡面的 data<br>這樣我們就可以讓 <code>authController.run</code> 裡面的 <code>apiService.login</code><br>不會真正去發送 POST Request，而是會回傳我們的結果<br>執行 mocha 後的結果如下<br><img src="/images/unit-test/mocha-1.png" alt></p>
<p>接下來我們再增加一個 test case，程式碼如下<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> apiServiceLogin = sinon.stub(apiService, <span class="string">"login"</span>)</span><br><span class="line">describe(<span class="string">"[登入功能]"</span>, () =&gt; &#123;</span><br><span class="line">    beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        apiServiceLogin.reset()</span><br><span class="line">    &#125;)</span><br><span class="line">    it(<span class="string">"登入成功"</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> req = mockRequest(&#123;</span><br><span class="line">            username: <span class="string">"123"</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">const</span> res = mockResponse();</span><br><span class="line">        apiServiceLogin.withArgs(<span class="string">"123"</span>).resolves(&#123;</span><br><span class="line">            status: <span class="number">0</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">await</span> authController.run(req, res)</span><br><span class="line">        sinon.assert.calledWith(res.json, &#123;</span><br><span class="line">            message: <span class="string">"登入成功"</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        sinon.assert.calledOnce(res.json);</span><br><span class="line">    &#125;)</span><br><span class="line">    it(<span class="string">"登入錯誤"</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> req = mockRequest(&#123;</span><br><span class="line">            username: <span class="string">"123"</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">const</span> res = mockResponse();</span><br><span class="line">        apiServiceLogin.withArgs(<span class="string">"123"</span>).resolves(&#123;</span><br><span class="line">            status: <span class="number">999</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">await</span> authController.run(req, res)</span><br><span class="line">        sinon.assert.calledWith(res.json, &#123;</span><br><span class="line">            message: <span class="string">"登入失敗"</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        sinon.assert.calledOnce(res.json);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>這邊要注意，已經被取代掉的 function，行為已經被我們第一個 test case 給固定了<br>為了要還原預設行為，必須在 <code>beforeEach</code> 加上  <code>reset()</code> 的方法<br>去重置每一個 test case <code>apiService.login</code> 回傳的行為，結果如下<br><img src="/images/unit-test/mocha-2.png" alt></p>
<h3><span id="express-with-sinon-spy">Express with Sinon Spy</span></h3><h4><span id="sinon-spy">Sinon Spy</span></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">"sinon"</span>);</span><br><span class="line"><span class="keyword">const</span> spy = sinon.spy();</span><br><span class="line">spy()</span><br><span class="line"><span class="built_in">console</span>.log(spy.callCount);</span><br><span class="line"><span class="comment">// 1</span></span><br></pre></td></tr></table></figure>
<p>基本上所有測試替身呼叫後，都是會回傳一個可執行 function 回來<br>根據前面介紹過，spy 是單純拿來做紀錄以及驗證<br>上面的範例來說，就可以知道這個 function 被呼叫一次<br>另外在 spy 的狀況下，function 實際行為是會被觸發，我們再來看另一段 code<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">"sinon"</span>);</span><br><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    test: <span class="function"><span class="keyword">function</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"this is test: "</span> + a</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> spy = sinon.spy(obj, <span class="string">"test"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(spy(<span class="string">"hihi"</span>));</span><br><span class="line"><span class="comment">// this is test: hihi</span></span><br><span class="line"><span class="built_in">console</span>.log(obj.test(<span class="string">"hihi2"</span>));</span><br><span class="line"><span class="comment">// this is test: hihi2</span></span><br><span class="line"><span class="built_in">console</span>.log(spy.callCount);</span><br><span class="line"><span class="comment">// 2</span></span><br></pre></td></tr></table></figure><br>以上面的例子可以看到，程式實際上的邏輯是有被觸發成功的<br>透過 spy 回傳的值，也是一個可執行的 function<br>透過 <code>spy()</code> 或是 <code>obj.test()</code> 去觸發，都會被記錄起來</p>
<h4><span id="如何在-express-上使用-spy">如何在 express 上使用  spy</span></h4><p>程式碼會增加一段對 username 進行 hash 再去做 login<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// authControler.js</span></span><br><span class="line"><span class="keyword">const</span> run = <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        username</span><br><span class="line">    &#125; = &#123;...req.body&#125;;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> apiService.login(hash.sha256(username))</span><br><span class="line">    <span class="keyword">if</span> (result.status !== <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.json(&#123;</span><br><span class="line">            message: <span class="string">"登入失敗"</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res.json(&#123;</span><br><span class="line">        message: <span class="string">"登入成功"</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// hash.js</span></span><br><span class="line"><span class="keyword">const</span> sha256 = <span class="function">(<span class="params">username</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> t = ctypto.createHash(<span class="string">"sha256"</span>);</span><br><span class="line">    <span class="keyword">return</span> t.update(username, <span class="string">"utf8"</span>).digest(<span class="string">"base64"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>先來跑跑看 unit test 會發現結果是錯的<br>原因是因為原本設定好 login 的時候，參數應該會是帶 <code>&quot;123&quot;</code><br>但因為變成 hash 之後會改成 <code>&quot;pmWkWSBCL51Bfkhn79xPuKBKHz//H6B+mY6G9/eieuM=&quot;</code><br>把 unit test 裡面的 withArgs 改成 <code>apiServiceLogin.withArgs(&quot;pmWkWSBCL51Bfkhn79xPuKBKHz//H6B+mY6G9/eieuM=&quot;)</code> 即可  </p>
<p>此時我們想要針對 <code>hash.sha256</code> 進行次數監控<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hashSha256 = sinon.spy(hash, <span class="string">"sha256"</span>);</span><br><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        apiServiceLogin.reset()</span><br><span class="line">        hashSha256.resetHistory()</span><br><span class="line">    &#125;)</span><br><span class="line">    it(<span class="string">"登入成功, hash 一次"</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> req = mockRequest(&#123;</span><br><span class="line">            username: <span class="string">"123"</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">const</span> res = mockResponse();</span><br><span class="line">        apiServiceLogin.withArgs(<span class="string">"pmWkWSBCL51Bfkhn79xPuKBKHz//H6B+mY6G9/eieuM="</span>).resolves(&#123;</span><br><span class="line">            status: <span class="number">0</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">await</span> authController.run(req, res)</span><br><span class="line">        sinon.assert.calledWith(res.json, &#123;</span><br><span class="line">            message: <span class="string">"登入成功"</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        sinon.assert.calledOnce(res.json);</span><br><span class="line">        sinon.assert.calledOnce(hashSha256)</span><br><span class="line">    &#125;)</span><br><span class="line">    it(<span class="string">"登入錯誤, hash 一次"</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> req = mockRequest(&#123;</span><br><span class="line">            username: <span class="string">"123"</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">const</span> res = mockResponse();</span><br><span class="line">        apiServiceLogin.withArgs(<span class="string">"pmWkWSBCL51Bfkhn79xPuKBKHz//H6B+mY6G9/eieuM="</span>).resolves(&#123;</span><br><span class="line">            status: <span class="number">999</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">await</span> authController.run(req, res)</span><br><span class="line">        sinon.assert.calledWith(res.json, &#123;</span><br><span class="line">            message: <span class="string">"登入失敗"</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        sinon.assert.calledOnce(res.json);</span><br><span class="line">        sinon.assert.calledOnce(hashSha256)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure></p>
<p>先在最前面加上 <code>const hashSha256 = sinon.spy(hash, &quot;sha256&quot;);</code> 取完成 spy 的動作<br>然後在最後面加上了驗證 <code>sinon.assert.calledOnce(hashSha256)</code> 就可以完成驗證動作<br>除此之外，要先在 <code>beforeEach</code> 加上 <code>hashSha256.resetHistory()</code> 去重置計算次數  </p>
<h3><span id="express-with-sinon-mock">Express with Sinon Mock</span></h3><h4><span id="sinon-mock">Sinon Mock</span></h4><p>不同於 stub 以及 spy<br>透過 mock 回傳的東西並不是一個可執行的 function<br>而是要透過此 mock 去進行設定，類似『驗證』用的東西<br>以及可以像是 stub 一樣，指定在 function 被呼叫的時候，應該會有什麼樣的回傳值<br>但又不同於 stub 以及 spy，mock 並不能直接去針對某一個做 mock<br>而是只能會對整個 obj 做 mock<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">"sinon"</span>);</span><br><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    test: <span class="function"><span class="keyword">function</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"this is test: "</span> + a</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> mock = sinon.mock(obj);</span><br><span class="line"><span class="comment">// 驗證只能最多被呼叫 2 次</span></span><br><span class="line">mock.expects(<span class="string">"test"</span>).atLeast(<span class="number">2</span>).returns(&#123;<span class="attr">status</span>: <span class="number">1</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(obj.test());</span><br><span class="line"><span class="comment">// &#123; status: 1 &#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(obj.test());</span><br><span class="line"><span class="comment">// &#123; status: 1 &#125;</span></span><br><span class="line"></span><br><span class="line">mock.verify()</span><br></pre></td></tr></table></figure></p>
<p>透過 <code>mock.expects(&quot;test&quot;).atLeast(2).returns({status: 1})</code> 去設定<br>預期哪一個 method 應該回傳什麼樣的值以及設定可被執行的次數<br>最後再透過 <code>mock.verify()</code> 可以啟用這個 assertion<br>除此之外，如果想要回復這個被 mock 原始的 method 的話<br>可以透過 <code>mock.restore()</code> 去做回覆的動作<br>這樣回覆之後，就會執行原本 function 的邏輯了  </p>
<h4><span id="如何在-express-上使用-mock">如何在 express 上使用 mock</span></h4><p>基本上程式碼跟上一個很像，但不一樣的地方在於<br>我想要針對 apiService.js 去進行驗證，以及模擬回傳值<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> apiServiceLogin = sinon.mock(apiService);</span><br><span class="line">it(<span class="string">"登入成功, hash 一次"</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> req = mockRequest(&#123;</span><br><span class="line">            username: <span class="string">"123"</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">const</span> res = mockResponse();</span><br><span class="line">        apiServiceLogin.expects(<span class="string">"login"</span>).withArgs(<span class="string">"pmWkWSBCL51Bfkhn79xPuKBKHz//H6B+mY6G9/eieuM="</span>).resolves(&#123;</span><br><span class="line">            status: <span class="number">0</span></span><br><span class="line">        &#125;).once();</span><br><span class="line">        <span class="keyword">await</span> authController.run(req, res)</span><br><span class="line">        sinon.assert.calledWith(res.json, &#123;</span><br><span class="line">            message: <span class="string">"登入成功"</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        sinon.assert.calledOnce(res.json);</span><br><span class="line">        sinon.assert.calledOnce(hashSha256)</span><br><span class="line">    &#125;)</span><br><span class="line">    it(<span class="string">"登入錯誤, hash 一次"</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> req = mockRequest(&#123;</span><br><span class="line">            username: <span class="string">"123"</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">const</span> res = mockResponse();</span><br><span class="line">        apiServiceLogin.expects(<span class="string">"login"</span>).withArgs(<span class="string">"pmWkWSBCL51Bfkhn79xPuKBKHz//H6B+mY6G9/eieuM="</span>).resolves(&#123;</span><br><span class="line">            status: <span class="number">-1</span></span><br><span class="line">        &#125;).once();</span><br><span class="line">        <span class="keyword">await</span> authController.run(req, res)</span><br><span class="line">        sinon.assert.calledWith(res.json, &#123;</span><br><span class="line">            message: <span class="string">"登入失敗"</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        sinon.assert.calledOnce(res.json);</span><br><span class="line">        sinon.assert.calledOnce(hashSha256)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure></p>
<p>差別在於以下程式，透過 mock，可以去指定回傳值，以及可以兼顧驗證用的功能<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apiServiceLogin.expects(<span class="string">"login"</span>).withArgs(<span class="string">"pmWkWSBCL51Bfkhn79xPuKBKHz//H6B+mY6G9/eieuM="</span>).resolves(&#123;</span><br><span class="line">    status: <span class="number">-1</span></span><br><span class="line">&#125;).once();</span><br></pre></td></tr></table></figure></p>
<h3><span id="express-with-sinon-fake">Express with Sinon Fake</span></h3><h4><span id="sinon-fake">Sinon Fake</span></h4><p>在 Sinon 官網上對於 Fake 的說明是<br>一種把 spy 跟 stub 混合的一種形式<br>所以這邊後面並不會介紹如何在 express 上面實作<br>而是會針對這個 fake 功能做些簡單的範例而已  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">"sinon"</span>);</span><br><span class="line"><span class="keyword">const</span> fake = sinon.fake.returns(&#123;<span class="attr">status</span>: <span class="number">1</span>&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(fake());</span><br><span class="line">&#123; <span class="attr">status</span>: <span class="number">1</span> &#125;</span><br></pre></td></tr></table></figure>
<p>跟 stub 一樣可以指定該 function 應該回傳的值<br>但他也有可以取代原本 method 的功能，程式如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sinon = <span class="built_in">require</span>(<span class="string">"sinon"</span>);</span><br><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">    test: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"test"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> fake = sinon.fake.returns(&#123;<span class="attr">status</span>: <span class="number">1</span>&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(obj.test());</span><br><span class="line"><span class="comment">// test</span></span><br><span class="line">sinon.replace(obj, <span class="string">"test"</span>, fake)</span><br><span class="line"><span class="built_in">console</span>.log(obj.test());</span><br><span class="line"><span class="comment">// &#123; status: 1 &#125;</span></span><br></pre></td></tr></table></figure>
<p>透過 <code>sinon.replace</code>，可以取代掉原本 function 的實際邏輯  </p>
<h2><span id="結語">結語</span></h2><p>以上介紹完每一個 test double 的意思以及使用場景<br>但使用場景上，我也還在思考什麼樣的場景可以搭配什麼去使用<br>歡迎各位一起在下面留言進行討論<br>未來會再針對實務上 unit test 遇到的困難再回來整理一篇  </p>
<h2><span id="references">References</span></h2><ol>
<li><a href="https://www.sitepoint.com/sinon-tutorial-javascript-testing-mocks-spies-stubs/" target="_blank" rel="noopener">https://www.sitepoint.com/sinon-tutorial-javascript-testing-mocks-spies-stubs/</a></li>
<li><a href="https://dev.to/milipski/test-doubles---fakes-mocks-and-stubs" target="_blank" rel="noopener">https://dev.to/milipski/test-doubles---fakes-mocks-and-stubs</a></li>
<li><a href="https://codewithhugo.com/express-request-response-mocking/" target="_blank" rel="noopener">https://codewithhugo.com/express-request-response-mocking/</a></li>
<li><a href="https://tpu.thinkpower.com.tw/tpu/articleDetails/1294" target="_blank" rel="noopener">https://tpu.thinkpower.com.tw/tpu/articleDetails/1294</a></li>
<li><a href="http://kaczanowscy.pl/tomek/2011-01/testing-basics-sut-and-docs" target="_blank" rel="noopener">http://kaczanowscy.pl/tomek/2011-01/testing-basics-sut-and-docs</a></li>
</ol>

                
                

                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/2019/12/22/unit-test-express-implement-troubleshooting/" data-toggle="tooltip" data-placement="top" title="express unit test 一些技巧教學以及困難點">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/2019/11/28/aws-cloudwatch-logs-insights/" data-toggle="tooltip" data-placement="top" title="AWS CloudWatch Logs Insights 介紹及教學">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                <!-- duoshuo Share start -->
                
                <!-- 多说 Share end-->

                <!-- 多说评论框 start -->
                
                <!-- 多说评论框 end -->
                <!-- <div id="liker">
                </div>
                <script type="text/javascript">
                    document.getElementById("liker").innerHTML = 
                    "<iframe scrolling='no' frameborder='0' sandbox='allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-storage-access-by-user-activation' style='height: 212px; width: 100%;' src='https://button.like.co/in/embed/jk82421/button?referrer=" +
                    encodeURIComponent(location.href.split("?")[0].split("#")[0]) + "'></iframe>";
                </script> -->
                <!-- disqus comment start -->
                
                    <div class="comment">
                        <div id="disqus_thread" class="disqus-thread"></div>
                    </div>
                
                <!-- disqus comment end -->
            </div>
            
                
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Table of Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#前言"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">前言</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#test-double-測試替身"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">Test Double - 測試替身</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#stub"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text">stub</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#spy"><span class="toc-nav-number">2.2.</span> <span class="toc-nav-text">spy</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#mock"><span class="toc-nav-number">2.3.</span> <span class="toc-nav-text">mock</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#fake"><span class="toc-nav-number">2.4.</span> <span class="toc-nav-text">fake</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#小結結語"><span class="toc-nav-number">2.5.</span> <span class="toc-nav-text">小結結語</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#實作"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">實作</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#express-with-sinon-stub"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">Express with Sinon Stub</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#sinon-stub-介紹"><span class="toc-nav-number">3.1.1.</span> <span class="toc-nav-text">Sinon Stub 介紹</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#如何在-express-上使用-stub"><span class="toc-nav-number">3.1.2.</span> <span class="toc-nav-text">如何在 express 上使用 stub</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#express-with-sinon-spy"><span class="toc-nav-number">3.2.</span> <span class="toc-nav-text">Express with Sinon Spy</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#sinon-spy"><span class="toc-nav-number">3.2.1.</span> <span class="toc-nav-text">Sinon Spy</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#如何在-express-上使用-spy"><span class="toc-nav-number">3.2.2.</span> <span class="toc-nav-text">如何在 express 上使用  spy</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#express-with-sinon-mock"><span class="toc-nav-number">3.3.</span> <span class="toc-nav-text">Express with Sinon Mock</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#sinon-mock"><span class="toc-nav-number">3.3.1.</span> <span class="toc-nav-text">Sinon Mock</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#如何在-express-上使用-mock"><span class="toc-nav-number">3.3.2.</span> <span class="toc-nav-text">如何在 express 上使用 mock</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#express-with-sinon-fake"><span class="toc-nav-number">3.4.</span> <span class="toc-nav-text">Express with Sinon Fake</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#sinon-fake"><span class="toc-nav-number">3.4.1.</span> <span class="toc-nav-text">Sinon Fake</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#結語"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">結語</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#references"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">References</span></a></li></ol>
        
        </div>
      </aside>
    

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                

                <!-- Friends Blog -->
                
            </div>
        </div>
    </div>
</article>






<!-- disqus embedded js code start (one page only need to embed once) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "yu-jack";
    var disqus_identifier = "https://yu-jack.github.io/2019/12/10/unit-test-express/";
    var disqus_url = "https://yu-jack.github.io/2019/12/10/unit-test-express/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus embedded js code start end -->






    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                

                

                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Jack Yu 2020 
                    <br>
                    <span id="busuanzi_container_site_pv">
                        Total <span id="busuanzi_value_site_pv"></span> views
                    </span>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->

<script src="/js/jquery.min.js"></script>


<!-- Bootstrap Core JavaScript -->

<script src="/js/bootstrap.min.js"></script>


<!-- Custom Theme JavaScript -->

<script src="/js/hux-blog.min.js"></script>



<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://yu-jack.github.io/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->




<!-- Baidu Tongji -->


<script>
mediumZoom("img")
</script>


	<!-- <a id="rocket" href="#top" class=""></a> -->
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/animejs/2.2.0/anime.min.js" async=""></script>
    <script type="text/javascript" src="/js/fireworks.js" async=""></script>
<!-- Image to hack wechat -->
<img src="https://yu-jack.github.io/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
