<!DOCTYPE html>
<html  lang="zh">
<head>
    <meta charset="utf-8" />

<meta name="generator" content="Hexo 4.2.0" />

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<title>標籤: nodejs - 技術雜記 Technology Notes - Jack Yu</title>

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NKT99TP');</script>

<script data-ad-client="ca-pub-1515253208026743" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


    <meta property="og:type" content="website">
<meta property="og:title" content="技術雜記 Technology Notes - Jack Yu">
<meta property="og:url" content="https://yu-jack.github.io/tags/nodejs/index.html">
<meta property="og:site_name" content="技術雜記 Technology Notes - Jack Yu">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://yu-jack.github.io/images/og_image.png">
<meta property="article:author" content="Jack Yu">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://yu-jack.github.io/images/og_image.png">







<link rel="icon" href="/images/favicon.svg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-dark.css">

    
    
<style>body>.footer,body>.navbar,body>.section{opacity:0}</style>

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">

    
    
    
    
<link rel="stylesheet" href="/css/back-to-top.css">

    
    
    
    
    
    
    
    <link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
    
    
    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <!-- <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/logo.svg" alt="技術雜記 Technology Notes - Jack Yu" height="28">
            
            </a>
        </div> -->
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">Home</a>
                
                <a class="navbar-item"
                href="/archives">Archives</a>
                
                <a class="navbar-item"
                href="/categories">Categories</a>
                
                <a class="navbar-item"
                href="/tags">Tags</a>
                
            </div>
            
            <div class="navbar-end">
                
                
                
                <a class="navbar-item search" title="搜尋" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-6-widescreen has-order-2 column-main"><div class="card">
    <div class="card-content">
        <nav class="breadcrumb" aria-label="breadcrumbs">
        <ul>
            <li><a href="/tags">標籤</a></li>
            <li class="is-active"><a href="#" aria-current="page">nodejs</a></li>
        </ul>
        </nav>
    </div>
</div>

    
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-06-02T04:13:07.000Z">2019-06-02</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/NodeJs/">NodeJs</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    9 分鐘 閱讀文 (大約 1293 個字)
                </span>
                
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/06/02/ajax-with-session/">前後端分離下之使用 session</a>
            
        </h1>
        <div class="content">
            <p>這邊主要在介紹當前後端架構上完全分離 (連 domain 都分離) 狀況下
要如何達到使用 session 的方法</p>
<p>知道 CORS 是什麼的人且想直接知道怎麼做可以直接跳到<a href="#%E9%87%8D%E9%BB%9E%E7%AD%86%E8%A8%98">重點筆記</a></p>
<p>&lt;!-- more --&gt;</p>
<h2><span id="前言">前言</span></h2>
<p>以往我們前後端程式是寫在一起時，都是透過後端程式去 render (渲染) 一個頁面<br>
而在前端頁面做請求的時候，請求都會帶著 cookie 到 server 上去判別是否屬於為同一個人<br>
但當我們在前後端完全分離的狀況下，該怎麼去達到這件事情呢?</p>
<h2><span id="cors">CORS</span></h2>
<p>瀏覽器有一個限制，當這個 request 請求起始的地方跟 endpoint 不一致得時候會造成所謂 CORS 的問題<br>
舉例來說，假設網站架設在 https://www.example.com 底下，但是你的 API Server 是在 https://www.example1.com 的話<br>
這樣網站 POST 到 API Server 的請求就會被阻擋 (這時 request 是從 html 頁面發起)</p>
<p>因為這個限制，API Server 往往要在 Header 上加上以下幾個東西去符合瀏覽器的規範</p>
<ol>
<li>Access-Control-Allow-Headers</li>
<li>Access-Control-Allow-Origin</li>
<li>Access-Control-Allow-Methods</li>
</ol>
<p>透過設置這三個 header 的參數，就可以讓前端合法的使用 API Server 了
所以按照剛剛的邏輯去加上 Header 會這樣加<br>
Access-Control-Allow-Headers: *<br>
Access-Control-Allow-Origin: https://www.example.com<br>
Access-Control-Allow-Methods: POST</p>
<p>然而在使用前後端分離的架構下，身份驗證以及授權就相對上就變得比較難一點<br>
雖然解法上還可以使用 JWT 去解決這個問題，但這篇文章主要會鎖定在用 sessino 的方式去解決</p>
<p>題外話，有一種方式也可以繞過 CORS，就是以 Proxy Server 的方式去實作
以下用著名的 Vue cli 為圖解
<img src="/images/vue-cli-proxy.png" alt></p>
<h2><span id="xhr-credential">XHR Credential</span></h2>
<p>當加上以上三個 CORS 的規範後<br>
會發現在發出 request 的時候，是不會帶入 cookie 去給 server 做驗證<br>
<img src="https://imgur.com/ATihx4F.png" alt></p>
<p>這時候就可以透過 xhr 裡面的 credential 去設定<br>
當把這個欄位設定成 true 的時候，request 就會夾帶 cookie 到 server 去<br>
<img src="https://i.imgur.com/neAHW1c.png" alt></p>
<h2><span id="詳細操作說明">詳細操作說明</span></h2>
<p>提到前後端完全分離的話，那我們就要準備兩個 server
一台 server 專門是讀取靜態 html 的 server<br>
一台 server 專門是處理 API 的 server</p>
<h3><span id="html-server">html server</span></h3>
<p>透過 Node.js 快速建立一個可以讀取靜態檔案的 server</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line">app.use(express.static(<span class="string">"./public"</span>));</span><br><span class="line">app.listen(<span class="number">8888</span>);</span><br></pre></td></tr></table></figure></p>
<p>而 <code>public/index.html</code> 的內容為</p>
<p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> ajax = <span class="keyword">new</span> XMLHttpRequest();</span></span><br><span class="line"><span class="actionscript">    ajax.open(<span class="string">'POST'</span>, <span class="string">'http://localhost:7777/test'</span>);</span></span><br><span class="line"><span class="actionscript">    ajax.setRequestHeader(<span class="string">'Content-Type'</span>, <span class="string">'application/json'</span>);</span></span><br><span class="line"><span class="actionscript">    ajax.onload = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line">        if (ajax.status === 200) &#123;</span><br><span class="line"><span class="actionscript">            alert(<span class="string">'Received '</span> + ajax.responseText);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="javascript">    ajax.send(<span class="built_in">JSON</span>.stringify(&#123;</span></span><br><span class="line"><span class="actionscript">        data: <span class="string">"hi from html"</span></span></span><br><span class="line">    &#125;));</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3><span id="api-server">api server</span></h3>
<p>另一台主要當作 api server<br>
主要就印出 session id 來觀看每一次的 request 是不是同一個人</p>
<pre><code class="language-javascript">const express = require('express');
const app = express();
const session = require('express-session')
var sess = {
  secret: 'keyboard cat',
  cookie: {},
  resave: true,
  saveUninitialized: false,
}

const bodyParser = require('body-parser');
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({
    extended: true
}));
app.use(session(sess))
app.use((req, res, next) =&gt; {
    res.setHeader(&quot;Access-Control-Allow-Headers&quot;, &quot;X-Requested-With, Accept, Content-Type, Cookie&quot;)
    res.setHeader(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;)
    res.setHeader(&quot;Access-Control-Allow-Methods&quot;, &quot;GET, HEAD, POST, PUT, DELETE, TRACE, OPTIONS, PATCH&quot;)
    next();
})
app.post('/test', (req, res) =&gt; {
    console.log(req.sessionID);
    req.session.a = &quot;hi&quot;
    res.json({a: 1})
})

app.listen(7777, () =&gt; {
    console.log('start');
});
</code></pre>
<h3><span id="實作">實作</span></h3>
<p>透過執行以上的兩個 server 程式，寫後近到 http://localhost:8080 之後<br>
按下幾次重整，可以看到 api server 印出來的 session 每一次都是不同個<br>
<img src="https://imgur.com/s8uwa99.png" alt></p>
<p>接下來就是要透過 xhr 的 credential 去設定
在 ajax 送出之前要加上 <code>ajax.withCredentials = true;</code> 這樣才可以把 Cookie 夾帶上去<br>
但會發現瀏覽器卻爆出另一個錯誤訊息<br>
<code>The value of the 'Access-Control-Allow-Credentials' header in the response is '' which must be 'true' when the request's credentials mode is 'include'</code><br>
<img src="https://imgur.com/B4OEBSz.png" alt>
這是前後端必須要同步都使用 credentials 才可以用<br>
於是在後端 server 加上 <code>Access-Control-Allow-Credentials: true</code></p>
<p>但再度重整之後又發現新的錯誤！
<code>The value of the 'Access-Control-Allow-Origin' header in the response must not be the wildcard '*' when the request's credentials mode is 'include'.</code>
<img src="https://imgur.com/HBreO9s.png" alt></p>
<p>其實這也是限制的一種，當使用到 credentials 的時候，後端必須多限制只有一個 domain 能使用<br>
<code>Access-Control-Allow-Origin: http://localhost:8888</code><br>
這樣設定之後按幾次重整就會發現 session id 是一致的了
<img src="https://imgur.com/DY6aSrr.png" alt></p>
<h2><span id="重點筆記">重點筆記</span></h2>
<h3><span id="後端必須加上以下的-headers">後端必須加上以下的 headers</span></h3>
<ol>
<li>Access-Control-Allow-Headers: *</li>
<li>Access-Control-Allow-Origin: http://localhost:8888
<blockquote>
<p>只能指定一個 domain，不能用 * 字號</p>
</blockquote>
</li>
<li>Access-Control-Allow-Methods: *</li>
<li>Access-Control-Allow-Credentials: true</li>
</ol>
<p>1, 3 兩點根據需要使用的 method 和 headers 再去客製化<br>
以資安來說建議不寫上 <code>*</code>，寫上有使用的就可以了</p>
<h3><span id="前端則是必須在-xhr-上面加上">前端則是必須在 xhr 上面加上</span></h3>
<ol>
<li>xhr.withCredentials = true</li>
</ol>
<h2><span id="後記">後記</span></h2>
<p>以上為簡單介紹如何在前後分離架構下依舊可以使用 session 的方式<br>
而文章有提到 JWT，那是另一種驗證及授權方式，有機會再來談談這個技術實作的方式</p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-05-02T14:42:27.000Z">2019-05-02</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/JavaScript/">JavaScript</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    11 分鐘 閱讀文 (大約 1625 個字)
                </span>
                
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/05/02/promise-2/">callback, promise, async/await 使用方式教學以及介紹 Part II (Error Handling 介紹)</a>
            
        </h1>
        <div class="content">
            <p>上一篇主要是介紹如何使用<br>
這篇會介紹該如何去在每一種使用方式之中去做 Error Handling</p>
<p>&lt;!-- more --&gt;</p>
<h2><span id="callback">callback</span></h2>
<p>相信各位有在使用別人第三方套件或是 Node.js 原生的 Library 都會發現一件事情<br>
那就是 callback 第一個參數都會是 error<br>
雖然這看似是一個不成文的規定，但仔細想想把 error 放在第一個是非常合理的<br>
假設當 callback 參數回傳越來越多的時候，總不可能把 error 放在最後一個去處理<br>
因為你會始終不知道哪一個會是 error (就算寫註解也會讀到瘋掉)<br>
試想一下這幾段 code 就可以理解了</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params">cb</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 當 function 成功後</span></span><br><span class="line">    cb(successful_data_1, successful_data_2)</span><br><span class="line">&#125;</span><br><span class="line">test(<span class="function">(<span class="params">successful_data_1, successful_data_2</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 開心地處理兩個回傳的資料</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// --- 分隔線  </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params">cb</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 當 function 失敗後</span></span><br><span class="line">    cb(error)</span><br><span class="line">&#125;</span><br><span class="line">test(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 咦? 第一個到底是 error 還是我原本的 successful_data_1</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>當遇到上面的狀況就會變得非常難判斷，但如果我整體改寫成這樣就會變得輕而易舉</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params">cb</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 當 function 成功後</span></span><br><span class="line">    cb(<span class="literal">null</span>, successful_data_1, successful_data_2)</span><br><span class="line">&#125;</span><br><span class="line">test(<span class="function">(<span class="params">error, successful_data_1, successful_data_2</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (error != <span class="literal">null</span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 開心地處理兩個回傳的資料</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// --- 分隔線  </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params">cb</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 當 function 失敗後</span></span><br><span class="line">    cb(error)</span><br><span class="line">&#125;</span><br><span class="line">test(<span class="function">(<span class="params">error, successful_data_1, successful_data_2</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (error != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 開心地處理 error, 於是 data_1 以及 data_2 就完全不用管他們了</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>當然有人會說<br>
『啊我就把所有參數丟到第一個當 Object 全部存起來，第二個就放 Error 也是一種方式啊』<br>
這樣講的話當然沒錯，但如果把所有東西都放在第一個 Object 裡面<br>
這樣參數就會有分類，使用問題也只是會徒增而已<br>
再加上這算是一種共識了，所以跟潛規則走會比較方便一點</p>
<h2><span id="promise">promise</span></h2>
<p>Promise 處理 error 的方式就比較特別了，我們先來看看一般 promise 出錯的時候是怎麼抓取的</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">        rej(<span class="string">"this is error"</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">test().then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;<span class="built_in">console</span>.log(<span class="string">"Get "</span> + data)&#125;).catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;<span class="built_in">console</span>.log(<span class="string">"handle! "</span> + error)&#125;); <span class="comment">// this is error</span></span><br></pre></td></tr></table></figure></p>
<p>上面為一般 promise 用 rej 的方式，外面用 catch 去抓住這個錯誤<br>
但凡事要考慮例外，萬一有一個 error 是你沒辦法 rej 到的話，那該要怎麼抓取?</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">        oqiwje() <span class="comment">// non-exist function</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">test().then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;<span class="built_in">console</span>.log(<span class="string">"Get "</span> + data)&#125;).catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;<span class="built_in">console</span>.log(<span class="string">"handle! "</span> + error)&#125;); <span class="comment">// this is error</span></span><br></pre></td></tr></table></figure></p>
<p>會發現當在 Promise 裡面出錯的話，外面的 catch 也是能抓到的<br>
其原因是因為 Promise 是有被一層內部的 try-catch 給包住<br>
且在內部的 catch 那一邊套用了預設地 rej function<br>
所以外面才抓得到</p>
<p>那如果放在 Promise 外面的話呢??</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    oqiwje() <span class="comment">// non-exist function</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">test().then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;<span class="built_in">console</span>.log(<span class="string">"Get "</span> + data)&#125;).catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;<span class="built_in">console</span>.log(<span class="string">"handle! "</span> + error)&#125;);</span><br></pre></td></tr></table></figure></p>
<p>咦!? 竟然抓不到，error 直接噴出來!<br>
但這也不意外，因為出了 Promise 到了外面<br>
那就是要透過自己去寫 try-catch 才能抓取到這個錯誤</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    oqiwje() <span class="comment">// non-exist function</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    test().then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;<span class="built_in">console</span>.log(<span class="string">"Get "</span> + data)&#125;).catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;<span class="built_in">console</span>.log(<span class="string">"handle! "</span> + error)&#125;);</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"handled by outer try-catch"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>還有一種 Handle 方式是寫在內層 function 裡面</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">        oqiwje() <span class="comment">// non-exist function</span></span><br><span class="line">    &#125;).catch(<span class="function"><span class="params">error</span> =&gt;</span> <span class="string">"handle by inner function"</span>)</span><br><span class="line">&#125;</span><br><span class="line">test().then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;<span class="built_in">console</span>.log(<span class="string">"Get "</span> + data)&#125;).catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;<span class="built_in">console</span>.log(<span class="string">"handle! "</span> + error)&#125;); <span class="comment">// Get handle by inner function</span></span><br></pre></td></tr></table></figure></p>
<p>那因為在 inner function 裡面被抓取到，並且回傳<br>
還記得 promise chain 中，如果 return 的話是會到下一個 then 去的<br>
所以這邊會被外面的 then 給抓到，而不是 catch，這邊要注意</p>
<p>Promise 的 Error Handling 只要能確保能執行到 rej 就沒什麼問題了<br>
然而在 Promise 之前用 try-catch 包起來或程式都丟到 Promise 裡面等他報錯丟出來也可以處理到</p>
<h2><span id="asyncawait">async/await</span></h2>
<p>await catch error 的方式可以想成一般 try-catch 的方式</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">        rej(<span class="string">"QQQ"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> result = <span class="keyword">await</span> test()</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Handled by main"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">main()</span><br></pre></td></tr></table></figure></p>
<p>而要特別注意的是，如果把 catch 寫在外面的 await 那裡的話<br>
會造成程式不會往最外層的 catch 前進</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">        rej(<span class="string">"QQQ"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> result = <span class="keyword">await</span> test().catch(<span class="function"><span class="params">()</span> =&gt;</span> &#123;<span class="built_in">console</span>.log(<span class="string">"Handled by await"</span>)&#125;)</span><br><span class="line">        <span class="comment">// 因為有正確被 handle 到，所以程式是會繼續下去執行的</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Still going"</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Handled by main"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">main()</span><br></pre></td></tr></table></figure></p>
<p>但如果透過在 catch function 裡面把 error 再次 throw 出來的話，是可以成功 throw 出來</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">        rej(<span class="string">"QQQ"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> result = <span class="keyword">await</span> test().catch(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"Handled by await"</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"QQQQ"</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 因為在上面做 throw error，所以程式不會繼續走下去</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Still going"</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Handled by main"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">main()</span><br></pre></td></tr></table></figure></p>
<p>千萬要注意 return 和 throw 的方式會帶來不一樣的結果<br>
使用 return 就跟 Promise 的 reject 的狀態下 return 是一樣的<br>
他會回傳到下一個 then 裡面 (也就是 resolved 的狀態)</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">        rej(<span class="string">"QQQ"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> result = <span class="keyword">await</span> test().catch(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"Handled by await"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"QQQQ"</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// 因為在上面做 return, 相當於是把結果回傳到 result 裡面了</span></span><br><span class="line">        <span class="built_in">console</span>.log(result); <span class="comment">// Error: QQQQ</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Still going"</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Handled by main"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">main()</span><br></pre></td></tr></table></figure></p>
<p>而個人比較不建議的寫法是在 await 那一層做 Error Handling<br>
而是盡量再底層那裡做 throw error 到最外面的 try-catch 去接<br>
原因是這跟 Design Pattern 有關係<br>
最外層的 main 可以想像是 Controller，而 test 可以想像成 Facade<br>
在裡面得程式才是真正的商業邏輯<br>
從下面程式來解讀的話，回家主要目的是要做功課<br>
那做功課一定會有流程，像是先吃飯，洗澡，最後在讀書這樣的順序<br>
但要怎麼吃飯洗澡讀書是要寫在每一個該做的項目的最裡面，而不會寫在順序那一層<br>
這樣程式撰寫上會比較乾淨一點</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">eatFirst</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            res(<span class="string">"Error"</span>);</span><br><span class="line">        &#125;, <span class="number">1000</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getBook</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            res(<span class="string">"Error"</span>);</span><br><span class="line">        &#125;, <span class="number">1000</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeIt</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            rej(<span class="string">"Books are ate by dogs!!!"</span>);</span><br><span class="line">        &#125;, <span class="number">1000</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">doHomeWork</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">await</span> eatFirst()</span><br><span class="line">    <span class="keyword">await</span> getBook()</span><br><span class="line">    <span class="keyword">await</span> writeIt()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> result = <span class="keyword">await</span> doHomeWork();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Handled by main"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">main();</span><br></pre></td></tr></table></figure></p>
<h2><span id="後記">後記</span></h2>
<p>這次主要介紹 Error Handling 的方式<br>
也加了一些個人建議撰寫的方法，如果有其他想法歡迎大家來討論！</p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2018-07-22T14:42:27.000Z">2018-07-22</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/JavaScript/">JavaScript</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    7 分鐘 閱讀文 (大約 1111 個字)
                </span>
                
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2018/07/22/promise/">callback, promise, async/await 使用方式教學以及介紹 Part I</a>
            
        </h1>
        <div class="content">
            <p>&lt;span style=&quot;color: green&quot;&gt;[Update 2019-05-02]&lt;/span&gt; 關於 Error Handing 可以看<a href="/2019/05/02/promise-2/">下一篇文章</a></p>
<p>這篇主要紀錄 callback, promise, async/await 的使用方式
以及為何會從到 callback 和 promise 的 hell world 進入到 async/await 這兩兄弟的世界
建議閱讀的人要有 Javascript 的基礎概念，包括對 non-blocking, event-driven 的觀念有一些涉略</p>
<p>&lt;!--more--&gt;</p>
<h2><span id="callback">Callback</span></h2>
<p>Callback 是 JS 很常用的一種使用方式
簡單來說，就是把 function 當作參數傳進去使用
以下是簡單的使用範例
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"This test function is done."</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"This is main start."</span>)</span><br><span class="line">    callback()</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"This is main end."</span>)</span><br><span class="line">&#125;</span><br><span class="line">main(test)</span><br><span class="line"><span class="comment">// This is main start.</span></span><br><span class="line"><span class="comment">// This test function is done.</span></span><br><span class="line"><span class="comment">// This is main end.</span></span><br></pre></td></tr></table></figure></p>
<p>但是 callback 使用上往往沒那麼簡單，基本上都會牽扯到 API 相關的用法
所以會變成下面這樣的方式
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 這邊模擬 test 這個 function 去 call 其他 API 要等待的情況</span></span><br><span class="line">    <span class="comment">// 等了一秒後才會執行 console.log 這個函式</span></span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span>=&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"This test function is done."</span>)</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"This is main start."</span>)</span><br><span class="line">    callback()</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"This is main end."</span>)</span><br><span class="line">&#125;</span><br><span class="line">main(test)</span><br><span class="line"><span class="comment">// This is main start.</span></span><br><span class="line"><span class="comment">// This is main end.</span></span><br><span class="line"><span class="comment">// This test function is done.</span></span><br></pre></td></tr></table></figure></p>
<p>這邊會發現，<code>This is main end.</code> 反而先執行印出來了, 這裡牽扯到 non-blocking 的概念, 將會放在別的章節重新介紹
那如果我想要 <code>This is main end.</code> 在最下面的話該怎麼做呢?
做法上只要把執行 <code>This is main end.</code> 的函示也當成 callback 傳進去就可以按照順序執行下來了
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params">callback2</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 這邊模擬 test 這個 function 去 call 其他 API 要等待的情況</span></span><br><span class="line">    <span class="comment">// 等了一秒後才會執行 console.log 這個函式</span></span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"This test function is done."</span>)</span><br><span class="line">        callback2()</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"This is main start."</span>)</span><br><span class="line">    callback(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"This is main end."</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">main(test)</span><br><span class="line"><span class="comment">// This is main start.</span></span><br><span class="line"><span class="comment">// This test function is done.</span></span><br><span class="line"><span class="comment">// This is main end.</span></span><br></pre></td></tr></table></figure></p>
<p>用 callback 解決的非同步的問題, 但是當越來越多 callback 串再一起
就會變成 callback hell, 如同下面這樣
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">api1</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Done with api1"</span>)</span><br><span class="line">        callback()</span><br><span class="line">    &#125;, <span class="number">2000</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">api2</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Done with api2"</span>)</span><br><span class="line">        callback()</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">    api1(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        api2(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            callback()</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">main(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"All function is done."</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// "Done with api1"</span></span><br><span class="line"><span class="comment">// "Done with api2"</span></span><br><span class="line"><span class="comment">// "All function is done."</span></span><br></pre></td></tr></table></figure></p>
<p>當越來越多 API 要<code>按照順序</code>做下去的時候就會很恐怖了，會變成這樣
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">api1(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    api2(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        api3(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            api4(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">// bla bla bla</span></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h2><span id="promise">Promise</span></h2>
<p>介紹完 callback 之後，一定要介紹他的好兄弟 Promise
Promise 是一個可以對非同步進行處理以及進行各種操作的東西
通常 Promise 會包含三種狀態 <code>resolve</code> <code>reject</code> <code>pending</code>
<code>resolve</code> 代表成功 <code>rejetc</code> 代表失敗, <code>pending</code> 代表還在處理中, 結束狀態未知
以下有兩種方式得知結果
<code>resolve</code> 會觸發 <code>onSuccessful</code>, reject 會觸發 <code>onFailed</code>
<code>promise.then(onSuccessful, onFailed)</code>
<code>promise.then(onSuccessful).catch(onFailed)</code>
以下是 Promise 的使用範例
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params">number</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (number === <span class="number">1</span>) &#123;</span><br><span class="line">            resolve(<span class="string">"Success"</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            reject(<span class="string">"Failed"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    test(<span class="number">1</span>).then(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// result === "Success"</span></span><br><span class="line">        <span class="built_in">console</span>.log(result)</span><br><span class="line">    &#125;).catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 不會被執行, 因為狀態是成功</span></span><br><span class="line">    &#125;)</span><br><span class="line">    test(<span class="number">2</span>).then(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 不會被執行, 因為狀態是成功</span></span><br><span class="line">        <span class="built_in">console</span>.log(result)</span><br><span class="line">    &#125;).catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// error === "Failed"</span></span><br><span class="line">        <span class="built_in">console</span>.log(error)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Promise 的基本介紹完之後，一定都會提到一個 Promise Chain 的概念
簡單來說就是我可以一直 <code>then</code> 下去，直到海枯石爛, 只要我在 <code>resolve</code> 或是 <code>reject</code> 的狀態下，<code>return</code> 任何東西都可以 <code>then</code> 下去
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params">number</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (number === <span class="number">1</span>) &#123;</span><br><span class="line">            resolve(<span class="string">"Success"</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            reject(<span class="string">"Failed"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    test(<span class="number">1</span>).then(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// result === "Success"</span></span><br><span class="line">        <span class="built_in">console</span>.log(result)</span><br><span class="line">        <span class="comment">// return "Next One"</span></span><br><span class="line">        <span class="keyword">return</span> test(<span class="number">1</span>)</span><br><span class="line">    &#125;).then(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// result === "Next One"</span></span><br><span class="line">        <span class="built_in">console</span>.log(result)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    test(<span class="number">2</span>).then(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// result === "Success"</span></span><br><span class="line">        <span class="built_in">console</span>.log(result)</span><br><span class="line">        <span class="comment">// return Promise 的物件也是可以的喔</span></span><br><span class="line">        <span class="keyword">return</span> test(<span class="number">1</span>)</span><br><span class="line">    &#125;).then(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// result === "Success"</span></span><br><span class="line">        <span class="built_in">console</span>.log(result)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>但是按照這樣的寫法下去, 又會變成另一種 then hell 的概念
於是接下來出現了 async/await 這兩兄弟</p>
<h2><span id="asyncawait">async/await</span></h2>
<p><code>async/await</code> 基本上是一種語法糖, 把 Promise 的重新包裝起來然後做使用
可以不用再透過 <code>then</code> 的方式去執行 Promise
使用方式會變成以下這樣
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params">number</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (number === <span class="number">1</span>) &#123;</span><br><span class="line">            resolve(<span class="string">"Success"</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            reject(<span class="string">"Failed"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="keyword">await</span> test(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">// result === "Success"</span></span><br><span class="line">    <span class="built_in">console</span>.log(result)</span><br><span class="line">&#125;</span><br><span class="line">main()</span><br></pre></td></tr></table></figure></p>
<p>記得在使用 <code>await</code> 的時候, function 前面一定要加上 <code>async</code>
所以當我有很多 API 要使用的話, 就會變得很乾淨
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> result1 = <span class="keyword">await</span> test1()</span><br><span class="line">    <span class="keyword">let</span> result2 = <span class="keyword">await</span> test2()</span><br><span class="line">    <span class="keyword">let</span> result3 = <span class="keyword">await</span> test3()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2><span id="結語">結語</span></h2>
<p>這 Part 主要是快速介紹使用教學方式
下一部分會介紹在這三種使用方式裡面是如何做到 <a href="/2019/05/02/promise-2/">Error Handling</a></p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2017-12-11T14:39:00.000Z">2017-12-11</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/NodeJs/">NodeJs</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    6 分鐘 閱讀文 (大約 937 個字)
                </span>
                
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2017/12/11/express-static/">Express 對靜態檔案做了什麼? 為什麼會被 cache 住呢?</a>
            
        </h1>
        <div class="content">
            <h2><span id="前言">前言</span></h2>
<p>最近突然有一個想法開始研究起瀏覽器端的 Cache 方法
加上小弟常用 nodejs + express 去寫前後端
於是開始研究起 express 裡面有一個 middleware 怎麼做起瀏覽器 cache 這件事</p>
<p>&lt;!-- more --&gt;</p>
<h2><span id="介紹">介紹</span></h2>
<p>在 express 裡面有一個 function 叫做 <code>express.static()</code>
這個是一個 middleware，最常被用在要讀取一些靜態檔案上面
以這個寫法來說 <code>app.use(express.static(__dirname + './public'))</code>
是指向 <code>public</code> 這個資校夾裡面，假設裡面有一個檔案叫做 <code>index.html</code> 的話，並且伺服器的 port 是 8080
那麼在網址列輸入 <code>http://localhost:8080/index.html</code> 這樣就可以讀到這個檔案了</p>
<h2><span id="追朔源頭">追朔源頭</span></h2>
<p>那我的疑問來了，我打開 Chrome Inspect 的 Network Tab 去看了一下他的 Response Headers
發現一件很奇怪的事情，我明明什麼都沒有設定，卻出現幾個有關 Cache 的 Headers</p>
<ol>
<li>Accept-Ranges</li>
<li>Cache-Control</li>
<li>ETag</li>
<li>Last-Modified</li>
</ol>
<p><img src="https://i.imgur.com/3O0nBTh.png" alt></p>
<blockquote>
<p>有關 Cache 的一些機制和理論就不多作介紹
這裡單純就爬一下 Source Code，看看 express 對靜態檔案做了什麼</p>
</blockquote>
<h3><span id="express">express</span></h3>
<p>在 express source code 中，發現他是用了另一個 library <code>server-static</code>
於在就再來看看 <code>server-static</code> 做了什麼</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exports.static = <span class="built_in">require</span>(<span class="string">'serve-static'</span>);</span><br></pre></td></tr></table></figure></p>
<h3><span id="serve-static">serve-static</span></h3>
<p>我只列出關鍵幾行，其他行主要都是設置參數用而已</p>
<p>從第一行可以看出，把 <code>serverStatic</code> 這個 function 給 export 出來了
再往下看會發現有一個 <code>send</code> function 把 <code>path</code> 傳了進去
然後在最後面，<code>stream.pipe(res)</code> 對 response 做了一些更動</p>
<p>於是再往下找找看 <code>send()</code> 這個是什麼東西</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = serveStatic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> send = <span class="built_in">require</span>(<span class="string">'send'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">serveStatic</span> (<span class="params">root, options</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Some codes ....</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> stream = send(req, path, opts)</span><br><span class="line">    <span class="comment">// Some codes ....</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// pipe</span></span><br><span class="line">    stream.pipe(res)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3><span id="send-send">send -- send</span></h3>
<p>根據上一段程式最後一段 (12行)，他 call 了一個 <code>pipe</code> 的 function
<code>pipe</code> function 裡面去 call <code>this.sendFile(path)</code>
<code>this.sendFile</code> 裡面又去 call <code>self.send(path, stat)</code>
然後在 <code>send</code> 這個 fucntion 裡面出現關鍵的 <code>function</code> -- <code>this.setHeader</code>
看來 response headers 就是在這邊被更改了</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = send</span><br><span class="line"></span><br><span class="line"><span class="comment">// 這邊回傳給到 server-static 去 call</span></span><br><span class="line"><span class="comment">// 也就是上一段程式碼的第 8 行，然後在第 </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span> (<span class="params">req, path, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> SendStream(req, path, options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SendStream.prototype.pipe = <span class="function"><span class="keyword">function</span> <span class="title">pipe</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.sendFile(path)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SendStream.prototype.sendFile = <span class="function"><span class="keyword">function</span> <span class="title">sendFile</span> (<span class="params">path</span>) </span>&#123;</span><br><span class="line"><span class="comment">// 這個等等 demo 截圖會看到，所以先留著</span></span><br><span class="line">  debug(<span class="string">'stat "%s"'</span>, path)</span><br><span class="line">  self.send(path, stat)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SendStream.prototype.send = <span class="function"><span class="keyword">function</span> <span class="title">send</span> (<span class="params">path, stat</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 這個等等 demo 截圖會看到，所以先留著</span></span><br><span class="line">  debug(<span class="string">'pipe "%s"'</span>, path)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set header fields</span></span><br><span class="line">  <span class="keyword">this</span>.setHeader(path, stat)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3><span id="send-setheader">send -- setHeader</span></h3>
<p>找到了對 header 做更動的地方後，以第 11 ~ 20 行中間這段 Code 來說
去設置了 Cache-Control 的內容，依照整個邏輯下如果沒有特別設置，那麼 header 會長以下這樣</p>
<p><code>Cache-Control: public, max-age=0</code></p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">SendStream.prototype.setHeader = <span class="function"><span class="keyword">function</span> <span class="title">setHeader</span> (<span class="params">path, stat</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> res = <span class="keyword">this</span>.res</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.emit(<span class="string">'headers'</span>, res, path, stat)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>._acceptRanges &amp;&amp; !res.getHeader(<span class="string">'Accept-Ranges'</span>)) &#123;</span><br><span class="line">    debug(<span class="string">'accept ranges'</span>)</span><br><span class="line">    res.setHeader(<span class="string">'Accept-Ranges'</span>, <span class="string">'bytes'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>._cacheControl &amp;&amp; !res.getHeader(<span class="string">'Cache-Control'</span>)) &#123;</span><br><span class="line">    <span class="keyword">var</span> cacheControl = <span class="string">'public, max-age='</span> + <span class="built_in">Math</span>.floor(<span class="keyword">this</span>._maxage / <span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._immutable) &#123;</span><br><span class="line">      cacheControl += <span class="string">', immutable'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    debug(<span class="string">'cache-control %s'</span>, cacheControl)</span><br><span class="line">    res.setHeader(<span class="string">'Cache-Control'</span>, cacheControl)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>._lastModified &amp;&amp; !res.getHeader(<span class="string">'Last-Modified'</span>)) &#123;</span><br><span class="line">    <span class="keyword">var</span> modified = stat.mtime.toUTCString()</span><br><span class="line">    debug(<span class="string">'modified %s'</span>, modified)</span><br><span class="line">    res.setHeader(<span class="string">'Last-Modified'</span>, modified)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>._etag &amp;&amp; !res.getHeader(<span class="string">'ETag'</span>)) &#123;</span><br><span class="line">    <span class="keyword">var</span> val = etag(stat)</span><br><span class="line">    debug(<span class="string">'etag %s'</span>, val)</span><br><span class="line">    res.setHeader(<span class="string">'ETag'</span>, val)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2><span id="demo">DEMO</span></h2>
<p>另外提供另個方法可以追回去 (我是懶得寫程式直接看 source code XD)
安裝完環境之後要跑 server 的時候，可以這樣下</p>
<p><code>DEBUG=* node server.js</code></p>
<p>從圖片中可以發現，那些 log message 是一樣的</p>
<p><img src="https://i.imgur.com/mhj2YxB.png" alt></p>
<h2><span id="後記">後記</span></h2>
<p>一直以來以為是 express 的做法讓檔案可以 cache 住
原來一直都是默默無名的 opensouce library 在幫助 express 啊
希望這篇有稍微幫助到對 express 處理 static files 有疑慮的人</p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2017-10-18T16:32:54.000Z">2017-10-19</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/NodeJs/">NodeJs</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    3 分鐘 閱讀文 (大約 405 個字)
                </span>
                
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2017/10/19/module-export/">Module Export</a>
            
        </h1>
        <div class="content">
            <p>稍微紀錄一下在 nodejs 裡面 module.exports 和 require
以及在 ECMA6 的 export 和 import 的使用方式</p>
<p>&lt;!--more--&gt;</p>
<h2><span id="nodejs">nodejs</span></h2>
<p>首先先在 a.js 裡面 export 出一個 object 裡面包含一個 click function
然後再 b.js 裡面用 require a.js，這時候會有兩種使用方式</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    click: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Hi'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// b.js</span></span><br><span class="line"><span class="comment">// 第一種</span></span><br><span class="line"><span class="keyword">const</span> a = <span class="built_in">require</span>(<span class="string">'./a.js'</span>)</span><br><span class="line">a.click()</span><br><span class="line"><span class="comment">// Hi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二種</span></span><br><span class="line"><span class="keyword">const</span> &#123;click&#125; = <span class="built_in">require</span>(<span class="string">'./a.js'</span>)</span><br><span class="line">click()</span><br><span class="line"><span class="comment">// Hi</span></span><br></pre></td></tr></table></figure></p>
<p>另外一種使用方式也可以達到同樣效果</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 這裡可以處理一些初始化的東西</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        click: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'Hi'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// b.js</span></span><br><span class="line"><span class="comment">// 第一種</span></span><br><span class="line"><span class="keyword">const</span> a = <span class="built_in">require</span>(<span class="string">'./a.js'</span>)()</span><br><span class="line">a.click()</span><br><span class="line"><span class="comment">// Hi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二種</span></span><br><span class="line"><span class="keyword">const</span> &#123;click&#125; = <span class="built_in">require</span>(<span class="string">'./a.js'</span>)()</span><br><span class="line">click()</span><br><span class="line"><span class="comment">// Hi</span></span><br></pre></td></tr></table></figure></p>
<p>接下來就用不同種例子，看看使用方式</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// b.js</span></span><br><span class="line"><span class="keyword">const</span> a = <span class="built_in">require</span>(<span class="string">'./a.js'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(a)</span><br><span class="line"><span class="comment">// [1, 2, 3]</span></span><br></pre></td></tr></table></figure></p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    name: <span class="string">'Hi'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// b.js</span></span><br><span class="line"><span class="keyword">const</span> a = <span class="built_in">require</span>(<span class="string">'./a.js'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(a.name);</span><br><span class="line"><span class="comment">// Hi</span></span><br></pre></td></tr></table></figure></p>
<h2><span id="ecma6">ECMA6</span></h2>
<p>我把上面的例子轉換成 ECMA6 import 和 export 的方式
但是有些地方會有些許不同</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    click: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'Hi'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// b.js</span></span><br><span class="line"><span class="keyword">import</span> a <span class="keyword">from</span> <span class="string">'./a.js'</span></span><br><span class="line">a.click()</span><br><span class="line"><span class="comment">// Hi</span></span><br></pre></td></tr></table></figure></p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a.js</span></span><br><span class="line"><span class="keyword">const</span> click = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Hi'</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">    click</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// b.js</span></span><br><span class="line"><span class="keyword">import</span> &#123;click&#125; <span class="keyword">from</span> <span class="string">'./a.js'</span></span><br><span class="line">click()</span><br><span class="line"><span class="comment">// Hi</span></span><br></pre></td></tr></table></figure></p>
<p>也可以搭配 as 和 * 去做 import (無法跟 export default 做搭配)</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a.js</span></span><br><span class="line"><span class="keyword">const</span> click = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Hi'</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">    click</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// b.js</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> a <span class="keyword">from</span> <span class="string">'./a.js'</span></span><br><span class="line">a.click()</span><br><span class="line"><span class="comment">// Hi</span></span><br></pre></td></tr></table></figure></p>
<p>接下來就用不同種例子，看看使用方式</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// b.js</span></span><br><span class="line"><span class="keyword">import</span> a <span class="keyword">from</span> <span class="string">'./a.js'</span></span><br><span class="line"><span class="built_in">console</span>.log(a);</span><br><span class="line"><span class="comment">// [1, 2, 3]</span></span><br></pre></td></tr></table></figure></p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a.js</span></span><br><span class="line"><span class="keyword">const</span> a = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">    a</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// b.js</span></span><br><span class="line"><span class="keyword">import</span> &#123;a&#125; <span class="keyword">from</span> <span class="string">'./a.js'</span></span><br><span class="line"><span class="built_in">console</span>.log(a);</span><br><span class="line"><span class="comment">// [1, 2, 3]</span></span><br></pre></td></tr></table></figure></p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    name: <span class="string">'hi'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 等同於</span></span><br><span class="line"><span class="keyword">const</span> a = &#123;</span><br><span class="line">    name: <span class="string">'hi'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> a</span><br><span class="line"></span><br><span class="line"><span class="comment">// b.js</span></span><br><span class="line"><span class="keyword">import</span> a <span class="keyword">from</span> <span class="string">'./a.js'</span></span><br><span class="line"><span class="built_in">console</span>.log(a.name);</span><br><span class="line"><span class="comment">// Hi</span></span><br></pre></td></tr></table></figure></p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2017-10-14T05:54:17.000Z">2017-10-14</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Bot/">Bot</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    15 分鐘 閱讀文 (大約 2191 個字)
                </span>
                
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2017/10/14/Slack-Bot/">Slack Bot</a>
            
        </h1>
        <div class="content">
            <p>在開始玩弄 Slack Bot 之前，必須要先去<a href="https://api.slack.com/apps">申請頁面</a>建立一個 APP</p>
<p><img src="https://i.imgur.com/mKD5GhV.png" alt></p>
<p>申請完之後，可以看到 Features 那邊有很多不同的功能
這次主要會針對 <strong>Slash Command</strong>、<strong>Incoming Webhooks</strong> 以及 <strong>Interactive Components</strong> 做練習</p>
<p>&lt;!--more--&gt;
<img src="https://i.imgur.com/xXeTr5w.png" alt></p>
<p>在開始正式介紹之前，我們可以思考一個情境
身為工程師，就是會想要降低人工干涉的事情，大量自動化
那今天，我想要自動部署我的 server 的話，可以怎麼做呢?</p>
<p>這裡可以透過 Slash Command + Incoming Webhooks 做到，步驟如下</p>
<ol>
<li>在 Slack 上面打上 /deploy ticket master (用 Slash Command 通知 server)</li>
<li>Server 就會接收到需要 deploy tickey server，然後切換到 master branch 上面</li>
<li>pull 最新版本之後，完成此次更新</li>
<li>通知公司同仁，更新已結束 (用 Incoming Webhooks 通知)</li>
</ol>
<p>這流程就會是我們所想要的，當然中間還可以透過 jenkins 去部署其他台伺服器
用 slack 部署 server，超方便 der (但感覺拿來訂便當更好用 XD</p>
<h2><span id="slash-command">Slash Command</span></h2>
<h3><span id="介紹">介紹</span></h3>
<p>Slash Command 就是在 Slack 的聊天室下指令，例如
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;deploy server</span><br></pre></td></tr></table></figure>
就會觸發到遠端伺服器，伺服器解析 command 後，再去近一步做一些行為</p>
<h3><span id="建立新指令">建立新指令</span></h3>
<p>下圖就是設定 Slash Command 的地方
我們設定了 command 為 /test，然後會用 <strong>POST</strong> 觸發到遠端的 https://your.website.com/test</p>
<p><img src="https://i.imgur.com/zrWlBqF.png" alt></p>
<p>比較重要的地方是，Request URL 一定要是 HTTPS，如果不是 HTTPS 一律拒絕，在 Slack 官方文件上面有以下這段說明</p>
<blockquote>
<p>NOTE: If your Slack app is set to be distributable or is part of the Slack app directory, the URL you provide must be use HTTPS with a valid, verifiable SSL certificate. Self-signed certificates cannot be used. See below for more information.</p>
</blockquote>
<p>按下 Save 之後，回到頁面會看到，就代表建立完成了</p>
<p><img src="https://i.imgur.com/CHfShmx.png" alt></p>
<h3><span id="安裝進到你的-team">安裝進到你的 team</span></h3>
<p>按下 Install App to Workspace，就會到授權頁面，然後點下 Authorize 即可安裝完成</p>
<p><img src="https://i.imgur.com/aXWYu8r.png" alt></p>
<p>安裝後在 channel 會出現訊息，通知說已經把 App 加入進來了</p>
<p><img src="https://i.imgur.com/VQ0s5oF.png" alt></p>
<p>這時候在聊天室裡面打下 /test 會出現我剛剛建立的 command 和 Description
不過輸入之後，並不會有任何反應，原因是因為我們還沒有設置好伺服器端的設定</p>
<p><img src="https://i.imgur.com/QLYSIqc.png" alt></p>
<h3><span id="開始寫程式去接受-slash-command">開始寫程式去接受 slash command</span></h3>
<p>這邊用 nodejs 示範建立一個簡單的伺服器去接受 slash command</p>
<p>SSL 的建立容許我這邊就不做示範了 XD (有點麻煩</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>);</span><br><span class="line">app.use(bodyParser.json());</span><br><span class="line">app.use(bodyParser.urlencoded(&#123;</span><br><span class="line">    extended: <span class="literal">false</span></span><br><span class="line">&#125;));</span><br><span class="line">app.post(<span class="string">'/test'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(req.body);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`User    :  <span class="subst">$&#123;req.body.user_name&#125;</span>`</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Text    :  <span class="subst">$&#123;req.body.text&#125;</span>`</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Command :  <span class="subst">$&#123;req.body.command&#125;</span>`</span>);</span><br><span class="line">                                       </span><br><span class="line">    <span class="keyword">return</span> res.json(&#123;</span><br><span class="line">        text: <span class="string">'Command is successful'</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">app.listen(<span class="number">8080</span>)</span><br></pre></td></tr></table></figure></p>
<p>在輸入視窗輸入以下指令後</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;test Hi I&#39;m from slack</span><br></pre></td></tr></table></figure></p>
<p>伺服器端會得到</p>
<p><img src="https://i.imgur.com/JoUUwJa.png" alt></p>
<p>完整的 JSON 格式如下
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 敏感資訊我都以 X 先馬掉了</span></span><br><span class="line">&#123;</span><br><span class="line">    token: <span class="string">'XXXXXXXXXXXXXXXXXXXXXXX'</span>,</span><br><span class="line">    team_id: <span class="string">'XXXXXXXXX'</span>,</span><br><span class="line">    team_domain: <span class="string">'XXXXXX'</span>,</span><br><span class="line">    channel_id: <span class="string">'XXXXXXXXX'</span>,</span><br><span class="line">    channel_name: <span class="string">'announcement'</span>,</span><br><span class="line">    user_id: <span class="string">'XXXXXXXXX'</span>,</span><br><span class="line">    user_name: <span class="string">'yujack'</span>,</span><br><span class="line">    command: <span class="string">'/test'</span>,</span><br><span class="line">    text: <span class="string">'Hi I\'m from slack'</span>,</span><br><span class="line">    response_url: <span class="string">'XXXXXXXXXXXXXX'</span>,</span><br><span class="line">    trigger_id: <span class="string">'XXXXXXXXXXXXXX'</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>而在輸入窗那邊會看到</p>
<p><img src="https://i.imgur.com/DbDiMPt.png" alt></p>
<p>代表指令有成功到伺服器上面了，然後回傳一個 &quot;Command is successful&quot;
指令完成後，一定會想問一個問題</p>
<p>『我想要通知其他人，我觸發了這個指令，我不想要只有我看到，那我該怎麼做？』</p>
<p>這時候就是下一個功能 Incoming Webhooks</p>
<h2><span id="incoming-webhooks">Incoming Webhooks</span></h2>
<h3><span id="介紹">介紹</span></h3>
<p>Incoming Webhook，可以直接讓你用 curl 的方式去發訊息到某一個 chaneel 裡面</p>
<h3><span id="啟用">啟用</span></h3>
<p>啟用 Incoming Webhooks 功能</p>
<p><img src="https://i.imgur.com/dQjIn5A.png" alt></p>
<p>啟用之後，會在下面看到一個範例，還有新增 Webhook 的地方</p>
<p><img src="https://i.imgur.com/qr9riue.png" alt></p>
<p>點選 &quot;Add New Webhook to Workspace&quot;，會到授權頁面
這裡會出現，你想要把訊息可以傳送到哪一個地方
那這裡我就選擇 general 作為範例</p>
<p><img src="https://i.imgur.com/BfQRZa0.png" alt></p>
<h3><span id="使用">使用</span></h3>
<p>在 terminal 貼上以下指令</p>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST -H 'Content-type: application/json' --data '&#123;"text":"Hello, World!"&#125;' https://hooks.slack.com/services/XXXXXXXX</span><br></pre></td></tr></table></figure></p>
<p>在你設定要傳送的那個 channel 就會出現訊息了</p>
<p><img src="https://i.imgur.com/zfH08LK.png" alt></p>
<p>那有了這個 Webhooks 之後，剛剛的 nodejs server 就可以稍微做更改
這樣的話就可以告訴那一個 channel 的人說，你執行了什麼樣的指令 ~</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>);</span><br><span class="line">app.use(bodyParser.json());</span><br><span class="line">app.use(bodyParser.urlencoded(&#123;</span><br><span class="line">    extended: <span class="literal">false</span></span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/test'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(req.body);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`User    :  <span class="subst">$&#123;req.body.user_name&#125;</span>`</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Text    :  <span class="subst">$&#123;req.body.text&#125;</span>`</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Command :  <span class="subst">$&#123;req.body.command&#125;</span>`</span>);</span><br><span class="line">                                       </span><br><span class="line">    <span class="keyword">const</span> command = <span class="string">`curl -X POST `</span> +</span><br><span class="line">        <span class="string">`-H 'Content-type: application/json' `</span> +</span><br><span class="line">        <span class="string">`--data '<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(req.body.slack_message)&#125;</span>' `</span> +</span><br><span class="line">        <span class="string">`https://hooks.slack.com/services/XXXXXXXXX`</span>;</span><br><span class="line"></span><br><span class="line">    exec(command, (error, stdout, stderr) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (error) &#123;</span><br><span class="line">            <span class="built_in">console</span>.error(<span class="string">`exec error: <span class="subst">$&#123;error&#125;</span>`</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res.json(&#123;</span><br><span class="line">            text: <span class="string">'Command is successful'</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">8080</span>)</span><br></pre></td></tr></table></figure></p>
<p>到這裡不禁會想到一個問題，我能不能不把 branch 記起來
我直接讓 server 告訴我，我在選一個我想要的去 deploy 呢?</p>
<p>這時候，Interactive Components 就派上用場了
這個功能可以接收使用者選擇了什麼選項，然後進一步去分析
接下來就要介紹 Interactive Components</p>
<h2><span id="interactive-components">Interactive Components</span></h2>
<h3><span id="介紹">介紹</span></h3>
<p>這是一個互動式的功能，在 Slack 上面可能會跳出</p>
<ol>
<li>Message Button : 例如是否同意這個意見?</li>
<li>Menus          : 例如訂 A 便當 or B 便當?</li>
<li>Dialogs        : 例如通知?</li>
</ol>
<p>當使用者點選了某一個按鈕或是選擇了其中一個選項
就會 post 到 server 上，跟 server 說使用者做了什麼選擇
學會 Interactive Componet 之後，我們自動化流程就可以改成</p>
<ol>
<li>在 Slack 上打 /show ticket (用 Slash Command 通知 server)</li>
<li>Server 回傳 ticket server 所有的 branch (用 Incoming Webhooks 通知)</li>
<li>使用者點選其中一個 branch 進行 deploy (用 Interactive Components 接收使用者點選哪一個 branch)</li>
<li>Server 就會接收到需要 deploy tickey server，然後切換到 master branch 上面</li>
<li>pull 最新版本之後，完成此次更新</li>
<li>通知公司同仁，更新已結束 (用 Incoming Webhooks 通知)</li>
</ol>
<h3><span id="啟用">啟用</span></h3>
<p><img src="https://i.imgur.com/OUfUkGZ.png" alt></p>
<h3><span id="使用">使用</span></h3>
<p>在使用 Interactive Componets 之前，要先學會如何製作選項或是按鈕給使用者點選
Slack 官方有提供地方可以客製化不同的按鈕或是表單的地方，<a href="https://api.slack.com/docs/messages/builder">點這進去</a>
我客製化了這個訊息</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"text"</span>: <span class="string">"Would you like to play a game?"</span>,</span><br><span class="line">    <span class="string">"attachments"</span>: [&#123;</span><br><span class="line">        <span class="string">"text"</span>: <span class="string">"Choose a game to play"</span>,</span><br><span class="line">        <span class="string">"fallback"</span>: <span class="string">"You are unable to choose a game"</span>,</span><br><span class="line">        <span class="string">"callback_id"</span>: <span class="string">"wopr_game"</span>,</span><br><span class="line">        <span class="string">"attachment_type"</span>: <span class="string">"default"</span>,</span><br><span class="line">        <span class="string">"actions"</span>: [&#123;</span><br><span class="line">            <span class="string">"name"</span>: <span class="string">"game"</span>,</span><br><span class="line">            <span class="string">"text"</span>: <span class="string">"Chess"</span>,</span><br><span class="line">            <span class="string">"type"</span>: <span class="string">"button"</span>,</span><br><span class="line">            <span class="string">"value"</span>: <span class="string">"chess"</span></span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>拿到訊息之後，利用 Incoming Webhooks 送出到使用者端給使用者點選</p>
<p><img src="https://i.imgur.com/8DtwtPG.png" alt></p>
<p>點選之後伺服器會發 POST 到 https://your.website.com/interactive
伺服器就會收到以下資訊</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Before JSON.Parse</span></span><br><span class="line">&#123;</span><br><span class="line">    payload: <span class="string">'&#123;"actions":[&#123;"name":"game","type":"button","value":"chess"&#125;],"callback_id":"wopr_game","team":&#123;"id":"XXXXXXXXX","domain":"XXXXXX"&#125;,"channel":&#123;"id":"XXXXXXXXX","name":"general"&#125;,"user":&#123;"id":"XXXXXXXXX","name":"yujack"&#125;,"action_ts":"1507970582.644321","message_ts":"1507970575.000002","attachment_id":"1","token":"XXXXXXXXXXXXXXXXXXXXXXX","is_app_unfurl":false,"type":"interactive_message","original_message":&#123;"text":"Would you like to play a game?","bot_id":"XXXXXXXXX","attachments":[&#123;"callback_id":"wopr_game","fallback":"You are unable to choose a game","text":"Choose a game to play","id":1,"actions":[&#123;"id":"1","name":"game","text":"Chess","type":"button","value":"chess","style":""&#125;]&#125;],"type":"message","subtype":"bot_message","ts":"1507970575.000002"&#125;,"response_url":"https:\\/\\/hooks.slack.com\\/actions\\/XXXXXXXXX\\/XXXXXXXXX\\/XXXXXXXXXXXXXXXXXXXXXXXXX","trigger_id":"XXXXXXXXX.XXXXXXXXX.XXXXXXXXXXXXXXXXXX"&#125;'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// After JSON.parse</span></span><br><span class="line">&#123;</span><br><span class="line">    payload: &#123;</span><br><span class="line">        actions: [&#123;</span><br><span class="line">            name: <span class="string">'game'</span>,</span><br><span class="line">            type: <span class="string">'button'</span>,</span><br><span class="line">            value: <span class="string">'chess'</span></span><br><span class="line">        &#125;],</span><br><span class="line">        callback_id: <span class="string">'wopr_game'</span>,</span><br><span class="line">        team: &#123;</span><br><span class="line">            id: <span class="string">'XXXXXXXXX'</span>,</span><br><span class="line">            domain: <span class="string">'XXXXXX'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        channel: &#123;</span><br><span class="line">            id: <span class="string">'XXXXXXXXX'</span>,</span><br><span class="line">            name: <span class="string">'general'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        user: &#123;</span><br><span class="line">            id: <span class="string">'XXXXXXXXX'</span>,</span><br><span class="line">            name: <span class="string">'yujack'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        action_ts: <span class="string">'1507970582.644321'</span>,</span><br><span class="line">        message_ts: <span class="string">'1507970575.000002'</span>,</span><br><span class="line">        attachment_id: <span class="string">'1'</span>,</span><br><span class="line">        token: <span class="string">'XXXXXXXXXXXXXXXXXXXXXXX'</span>,</span><br><span class="line">        is_app_unfurl: <span class="literal">false</span>,</span><br><span class="line">        type: <span class="string">'interactive_message'</span>,</span><br><span class="line">        original_message: &#123;</span><br><span class="line">            text: <span class="string">'Would you like to play a game?'</span>,</span><br><span class="line">            bot_id: <span class="string">'XXXXXXXXX'</span>,</span><br><span class="line">            attachments: [</span><br><span class="line">                [<span class="built_in">Object</span>]</span><br><span class="line">            ],</span><br><span class="line">            type: <span class="string">'message'</span>,</span><br><span class="line">            subtype: <span class="string">'bot_message'</span>,</span><br><span class="line">            ts: <span class="string">'1507970575.000002'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        response_url: <span class="string">'https://hooks.slack.com/actions/XXXXXXXXX/XXXXXXXXX/XXXXXXXXXXXXXXXXXXXXXXXXX'</span>,</span><br><span class="line">        trigger_id: <span class="string">'XXXXXXXXX.XXXXXXXXX.XXXXXXXXXXXXXXXXXX'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>按鈕會消失，然後顯示你在 server 上面回傳的完成資訊
收到資訊之後，就可以知道使用者點選了什麼按鈕或是選擇了什麼選項
根據這些選項伺服器在做一些處理就可以完成了</p>
<p><img src="https://i.imgur.com/JaE9My4.png" alt></p>
<p>伺服器上面的程式會長這樣 (這邊單純印出來而已，沒有做後續處理</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">app.post(<span class="string">'/interactive'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(req.body);</span><br><span class="line">    <span class="keyword">return</span> res.json(&#123;</span><br><span class="line">        text: <span class="string">'Command is successful'</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h2><span id="結論">結論</span></h2>
<p>我用了一個情境讓大家比較好思考如何把這三個功能串起來
雖然我還是覺得用在訂便當上面很方便就是了 (?</p>
<p>不過有些細部關於真正如何部署或是 SSL 的部分這裡就不會說明了
那個會需要花到一兩篇文章的篇幅去介紹</p>
<p>如果有任何問題，請歡迎一起來討論 ~</p>

        </div>
        
        
        
    </div>
</div>








    
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2017-09-23T03:43:00.000Z">2017-09-23</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Payment-Gateway/">Payment Gateway</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    10 分鐘 閱讀文 (大約 1563 個字)
                </span>
                
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2017/09/23/tappay-payment/">如何串接上 TapPay 並完成第一筆交易!</a>
            
        </h1>
        <div class="content">
            <p>這篇文章主要是說明如何使用 TapPay 這個服務
TapPay 是一家金流廠商，主要都是做線上金流，詳細就不多說
有興趣想要詳細了解可以去參考官網 https://www.tappaysdk.com</p>
<p>最近剛好被派去串接 TapPay 的服務，就順便把整個流程給記錄下來了
這邊會以 Web 服務為主去做範例，完整程式碼，請參考最下面</p>
<p>&lt;!--more--&gt;</p>
<h2><span id="環境設置">環境設置</span></h2>
<ol>
<li>
<p>TapPay Portal 申請</p>
<p>要拿到以下的值才有辦法作後續的付款</p>
<ul>
<li>App Key (應用程式頁面)</li>
<li>App ID (應用程式頁面)</li>
<li>Partner Key (帳號資訊頁面)</li>
<li>Merchant ID (商家管理頁面)</li>
</ul>
</li>
<li>
<p>程式部分</p>
<ul>
<li>前端: HTML + Javascript + CSS</li>
<li>後端: nodejs (v6)</li>
</ul>
</li>
<li>
<p>網域部分</p>
<ul>
<li>設置 /etc/hosts
這邊要特別注意，要去 /etc/hots 底下設置
跟在 TapPay Portal 所建立的 domain 一樣
才有辦法 Get Prim，否則會一直出現 CORS 的問題
待會在細部流程的時候會做介紹</li>
</ul>
</li>
<li>
<p>測試卡號</p>
<p>測試卡號可以參考這裡
https://docs.tappaysdk.com/tutorial/zh/reference.html#test-card
card number 4242424242424242
month 01
year 23
ccv 123</p>
</li>
</ol>
<h2><span id="流程介紹">流程介紹</span></h2>
<p>主要分成以下幾個步驟</p>
<ul>
<li>
<p>前端</p>
<ol>
<li>使用 TapPay SDK 設置好輸入卡號的表單</li>
<li>按下按鈕觸發 TapPay 的 GetPrime 方法</li>
<li>拿到 Prime</li>
<li>把 Prime 送到後端</li>
</ol>
</li>
<li>
<p>後端</p>
<ol>
<li>拿到前端送來的 Prime</li>
<li>把 Prime 加上其他所需參數送往 TapPay Server</li>
<li>完成付款!</li>
</ol>
</li>
</ul>
<h2><span id="程式撰寫-前端">程式撰寫 - 前端</span></h2>
<p>根據最新的 SDK 發佈的方法, 可以直接在一個 element 底下把卡號輸入表單塞進去</p>
<h3><span id="html">HTML</span></h3>
<p>HTML 分成兩個部分</p>
<ol>
<li>建立好一個 div 準備等等被塞入輸入卡號表單</li>
<li>建立好 trigger button 來觸發 Get Prime 方法</li>
</ol>
<p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"width: 480px; margin: 50px auto;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>CardView<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 這是我們要塞表單的地方 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"cardview-container"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 這是我們要觸發 GetPrime 方法的地方 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"submit-button"</span> <span class="attr">onclick</span>=<span class="string">"onClick()"</span>&gt;</span>Get Prime<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3><span id="javascript">Javascript</span></h3>
<p>Javascript 分成三個部分</p>
<ol>
<li>初始化金鑰</li>
<li>植入輸入卡號表單</li>
<li>觸發 getPrime 方法</li>
</ol>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 設置好等等 GetPrime 所需要的金鑰</span></span><br><span class="line">TPDirect.setupSDK(APP_ID, <span class="string">"APP_KEY"</span>, <span class="string">"sandbox"</span>)</span><br><span class="line">				  </span><br><span class="line"><span class="comment">// 把 TapPay 內建輸入卡號的表單給植入到 div 中</span></span><br><span class="line">TPDirect.card.setup(<span class="string">'#cardview-container'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> submitButton = <span class="built_in">document</span>.querySelector(<span class="string">'#submit-button'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onClick</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 讓 button click 之後觸發 getPrime 方法</span></span><br><span class="line">    TPDirect.card.getPrime(<span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (result.status !== <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">console</span>.err(<span class="string">'getPrime 錯誤'</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> prime = result.card.prime</span><br><span class="line">        alert(<span class="string">'getPrime 成功: '</span> + prime)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>沒錯！你沒看錯，不到 30 行
但是，這邊要注意到一個地方，如果你 Get Prime 之後沒有任何反應
打開開發者模式後卻看到了這個
getPrime 錯誤
題外話，如果並不使用 TPDirect.card.setup 版本的話
而是自己實作整個流程，則會看到 CORS 的紅字</p>
<p>這個代表你開發的網域和你在 TapPay Portal 上面所填寫的網域是不一樣的
這就是一開始在環境設置提到的 /etc/hosts 有關係</p>
<p>假設你未來可能要使用的網域是 example-tappay.yujack.com 的話
請到 /etc/hosts localhost 下面加上一段</p>
<p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 localhost</span><br><span class="line">127.0.0.1 example-tappay.yujack.com</span><br></pre></td></tr></table></figure></p>
<p>然後回到網頁上把 URL 從
http://localhost:8080/ 改成 http://example-tappay.yujack.com:8080/
這樣 Get Prime 就會成功了！</p>
<p>不過要注意，如果你未來要用的網域是已經在用的話
在 /etc/hosts 底下是上去是沒有用的
所以切記用一個沒在用的網域做測試
否則 .. 你只好直接部署上去測試了</p>
<h2><span id="程式撰寫-後端">程式撰寫 - 後端</span></h2>
<p>小弟我是習慣用 nodejs 撰寫後端伺服器
所以這邊會以 nodejs 去做付款的動作
前端 Get Prime 成功之後, 就要把這組 prime 送到後端了</p>
<h3><span id="建立-nodejs-server">建立 NodeJs server</span></h3>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>)</span><br><span class="line"><span class="keyword">const</span> https = <span class="built_in">require</span>(<span class="string">'https'</span>);</span><br><span class="line"><span class="keyword">const</span> PORT = <span class="number">8080</span></span><br><span class="line"></span><br><span class="line">app.use(bodyParser.json())</span><br><span class="line">app.use(bodyParser.urlencoded(&#123;</span><br><span class="line">    extended: <span class="literal">false</span></span><br><span class="line">&#125;))</span><br><span class="line">app.use(<span class="string">'/'</span>, express.static(__dirname + <span class="string">"/html"</span>)) <span class="comment">//serve static content</span></span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/pay-by-prime'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 必須要把程式實作在這邊</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(PORT, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Connet your webiste in the http://localhost:8080/'</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h3><span id="實作-pay-by-prime">實作 Pay by Prime</span></h3>
<p>接下來要實作 pay-by-prime 的程式
要加到 app.post('/pay-by-prime') 裡面
這裡有兩個參數要注意
兩個都是在 TapPay Portal 上面申請帳號時會獲得的，程式如下</p>
<ol>
<li>Partner Key (帳號資訊頁面)</li>
<li>Merchant ID (商家管理頁面)</li>
</ol>
<p>另外就是 headers 裡面要特別帶 x-api-key 進去
否則會收到 access deny 的 response</p>
<p>可以參考 https://docs.tappaysdk.com/tutorial/zh/back.html#pay-by-prime-api
所需要帶的參數和 headers</p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> post_data = &#123;</span><br><span class="line">    <span class="comment">// prime from front-end</span></span><br><span class="line">    <span class="string">"prime"</span>: req.body.prime,</span><br><span class="line">    <span class="string">"partner_key"</span>: <span class="string">"PARTNER_KEY"</span>,</span><br><span class="line">    <span class="string">"merchant_id"</span>: <span class="string">"MERCHANT_ID"</span>,</span><br><span class="line">    <span class="string">"amount"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">"currency"</span>: <span class="string">"TWD"</span>,</span><br><span class="line">    <span class="string">"details"</span>: <span class="string">"An apple and a pen."</span>,</span><br><span class="line">    <span class="string">"cardholder"</span>: &#123;</span><br><span class="line">        <span class="string">"phone_number"</span>: <span class="string">"+886923456789"</span>,</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"yujack"</span>,</span><br><span class="line">        <span class="string">"email"</span>: <span class="string">"example@gmail.com"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"instalment"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">"remember"</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> post_options = &#123;</span><br><span class="line">    host: <span class="string">'sandbox.tappaysdk.com'</span>,</span><br><span class="line">    port: <span class="number">443</span>,</span><br><span class="line">    path: <span class="string">'/tpc/payment/pay-by-prime'</span>,</span><br><span class="line">    method: <span class="string">'POST'</span>,</span><br><span class="line">    headers: &#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>,</span><br><span class="line">        <span class="comment">// 這個參數必須要帶上去，否則不會過</span></span><br><span class="line">        <span class="string">'x-api-key'</span>: <span class="string">'PARTNER_KEY'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> post_req = https.request(post_options, <span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">    response.setEncoding(<span class="string">'utf8'</span>);</span><br><span class="line">    response.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">body</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> res.json(&#123;</span><br><span class="line">            result: <span class="built_in">JSON</span>.parse(body)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">post_req.write(<span class="built_in">JSON</span>.stringify(post_data));</span><br><span class="line">post_req.end();</span><br></pre></td></tr></table></figure></p>
<p>實作完成後，開啟 nodejs server
然後打上測試卡後就可以完成付款了！
打完收工！下班去！</p>
<h3><span id="前端補正">前端補正</span></h3>
<p>記得前端要補上把 prime 帶上來的程式
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$.post(<span class="string">'/pay-by-prime'</span>, &#123;<span class="attr">prime</span>: prime&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    alert(<span class="string">'付款成功'</span> + <span class="built_in">JSON</span>.stringify(data))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h2><span id="完整程式碼">完整程式碼</span></h2>
<h3><span id="資料夾結構">資料夾結構</span></h3>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">|</span><br><span class="line">|--- app.js</span><br><span class="line">|</span><br><span class="line">|----html</span><br><span class="line">|     |---index.html</span><br></pre></td></tr></table></figure></p>
<h3><span id="前端">前端</span></h3>
<p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">text</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"https://js.tappaysdk.com/tpdirect/v2_2_1"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://code.jquery.com/jquery-2.2.4.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Connect payment with TapPay<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"width: 480px; margin: 50px auto;"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>CardView<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"cardview-container"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"submit-button"</span> <span class="attr">onclick</span>=<span class="string">"onClick()"</span>&gt;</span>Get Prime<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pre</span> <span class="attr">id</span>=<span class="string">"result1"</span>&gt;</span><span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pre</span> <span class="attr">id</span>=<span class="string">"result2"</span>&gt;</span><span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        TPDirect.setupSDK(APP_ID, <span class="string">'APP_KEY'</span>, <span class="string">'sandbox'</span>)</span></span><br><span class="line"><span class="actionscript">        TPDirect.card.setup(<span class="string">'#cardview-container'</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> submitButton = <span class="built_in">document</span>.querySelector(<span class="string">'#submit-button'</span>)</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> cardViewContainer = <span class="built_in">document</span>.querySelector(<span class="string">'#cardview-container'</span>)</span></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">onClick</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            TPDirect.card.getPrime(<span class="function"><span class="keyword">function</span> <span class="params">(result)</span> </span>&#123;</span></span><br><span class="line">                if (result.status !== 0) &#123;</span><br><span class="line"><span class="javascript">                    <span class="built_in">console</span>.log(<span class="string">'getPrime 錯誤'</span>)</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">return</span></span></span><br><span class="line">                &#125;</span><br><span class="line"><span class="actionscript">                alert(<span class="string">'getPrime 成功'</span>)</span></span><br><span class="line"><span class="actionscript">                <span class="keyword">var</span> prime = result.card.prime</span></span><br><span class="line"><span class="javascript">                <span class="built_in">document</span>.querySelector(<span class="string">'#result1'</span>).innerHTML = <span class="built_in">JSON</span>.stringify(result, <span class="literal">null</span>, <span class="number">4</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">                $.post(<span class="string">'/pay-by-prime'</span>, &#123;<span class="attr">prime</span>: prime&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span></span><br><span class="line"><span class="actionscript">                    alert(<span class="string">'付款成功'</span>)</span></span><br><span class="line"><span class="javascript">                    <span class="built_in">document</span>.querySelector(<span class="string">'#result2'</span>).innerHTML = <span class="built_in">JSON</span>.stringify(data, <span class="literal">null</span>, <span class="number">4</span>)</span></span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3><span id="後端">後端</span></h3>
<p>記得先執行以下 command
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install body-parser express</span><br></pre></td></tr></table></figure></p>
<p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>)</span><br><span class="line"><span class="keyword">const</span> https = <span class="built_in">require</span>(<span class="string">'https'</span>);</span><br><span class="line"><span class="keyword">const</span> PORT = <span class="number">8080</span></span><br><span class="line"></span><br><span class="line">app.use(bodyParser.json())</span><br><span class="line">app.use(bodyParser.urlencoded(&#123;</span><br><span class="line">    extended: <span class="literal">false</span></span><br><span class="line">&#125;))</span><br><span class="line">app.use(<span class="string">'/'</span>, express.static(__dirname + <span class="string">"/html"</span>)) <span class="comment">//serve static content</span></span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/pay-by-prime'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> post_data = &#123;</span><br><span class="line">        <span class="string">"prime"</span>: req.body.prime,</span><br><span class="line">        <span class="string">"partner_key"</span>: <span class="string">"PARTNER_KEY"</span>,</span><br><span class="line">        <span class="string">"merchant_id"</span>: <span class="string">"MERCHANT_ID"</span>,</span><br><span class="line">        <span class="string">"amount"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">"currency"</span>: <span class="string">"TWD"</span>,</span><br><span class="line">        <span class="string">"details"</span>: <span class="string">"An apple and a pen."</span>,</span><br><span class="line">        <span class="string">"cardholder"</span>: &#123;</span><br><span class="line">            <span class="string">"phone_number"</span>: <span class="string">"+886923456789"</span>,</span><br><span class="line">            <span class="string">"name"</span>: <span class="string">"jack"</span>,</span><br><span class="line">            <span class="string">"email"</span>: <span class="string">"example@gmail.com"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"remember"</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> post_options = &#123;</span><br><span class="line">        host: <span class="string">'sandbox.tappaysdk.com'</span>,</span><br><span class="line">        port: <span class="number">443</span>,</span><br><span class="line">        path: <span class="string">'/tpc/payment/pay-by-prime'</span>,</span><br><span class="line">        method: <span class="string">'POST'</span>,</span><br><span class="line">        headers: &#123;</span><br><span class="line">            <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>,</span><br><span class="line">            <span class="string">'x-api-key'</span>: <span class="string">'PARTNER_KEY'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> post_req = https.request(post_options, <span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">        response.setEncoding(<span class="string">'utf8'</span>);</span><br><span class="line">        response.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">body</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> res.json(&#123;</span><br><span class="line">                result: <span class="built_in">JSON</span>.parse(body)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    post_req.write(<span class="built_in">JSON</span>.stringify(post_data));</span><br><span class="line">    post_req.end();</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(PORT, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Connet your webiste in the http://localhost:8080/'</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>

        </div>
        
        
        
    </div>
</div>








</div>
                





<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered" style="flex-shrink: 1">
                <div>
                    <!-- 
                    <figure class="image is-128x128 has-mb-6">
                        <img class="" src="/images/avatar.png" alt="Jack">
                    </figure> -->
                    
                    <p class="is-size-4 is-block">
                        Jack
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        Software Developer
                    </p>
                    
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <a href="/archives">
                        <p class="title has-text-weight-normal">
                            33
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分類
                    </p>
                    <a href="/categories">
                        <p class="title has-text-weight-normal">
                            13
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        標籤
                    </p>
                    <a href="/tags">
                        <p class="title has-text-weight-normal">
                            64
                        </p>
                    </a>
                </div>
            </div>
        </nav>
        
        
        
    </div>
</div>
    
        
    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                分類
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/Security/">
            <span class="level-start">
                <span class="level-item">Security</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">9</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/AWS/">
            <span class="level-start">
                <span class="level-item">AWS</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">7</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Test/">
            <span class="level-start">
                <span class="level-item">Test</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/NodeJs/">
            <span class="level-start">
                <span class="level-item">NodeJs</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/JavaScript/">
            <span class="level-start">
                <span class="level-item">JavaScript</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Java/">
            <span class="level-start">
                <span class="level-item">Java</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Bot/">
            <span class="level-start">
                <span class="level-item">Bot</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Payment-Gateway/">
            <span class="level-start">
                <span class="level-item">Payment Gateway</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Google/">
            <span class="level-start">
                <span class="level-item">Google</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Development/">
            <span class="level-start">
                <span class="level-item">Development</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Vue/">
            <span class="level-start">
                <span class="level-item">Vue</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/debug/">
            <span class="level-start">
                <span class="level-item">debug</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/tool/">
            <span class="level-start">
                <span class="level-item">tool</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            彙整
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2020/01/">
                <span class="level-start">
                    <span class="level-item">一月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/10/">
                <span class="level-start">
                    <span class="level-item">十月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/09/">
                <span class="level-start">
                    <span class="level-item">九月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/06/">
                <span class="level-start">
                    <span class="level-item">六月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/05/">
                <span class="level-start">
                    <span class="level-item">五月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/04/">
                <span class="level-start">
                    <span class="level-item">四月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/02/">
                <span class="level-start">
                    <span class="level-item">二月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/01/">
                <span class="level-start">
                    <span class="level-item">一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/09/">
                <span class="level-start">
                    <span class="level-item">九月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/07/">
                <span class="level-start">
                    <span class="level-item">七月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/04/">
                <span class="level-start">
                    <span class="level-item">四月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/10/">
                <span class="level-start">
                    <span class="level-item">十月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/09/">
                <span class="level-start">
                    <span class="level-item">九月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
            <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-01-08T16:30:25.000Z">2020-01-09</time></div>
                    <a href="/2020/01/09/express-get-client-ip-from-load-balancer/" class="title has-link-black-ter is-size-6 has-text-weight-normal">如何從多層 Load Balancer / Nginx 取得使用者正確的 IP?</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Security/">Security</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-01-06T15:10:13.000Z">2020-01-06</time></div>
                    <a href="/2020/01/06/aws-increase-disk-space-in-ec2/" class="title has-link-black-ter is-size-6 has-text-weight-normal">如何增加 EC2 硬碟大小 (Expand the disk space in EC2)</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/AWS/">AWS</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-01-06T02:16:52.000Z">2020-01-06</time></div>
                    <a href="/2020/01/06/aws-certificate-manager/" class="title has-link-black-ter is-size-6 has-text-weight-normal">AWS Certificate Manager 如何更換憑證 (Reimport Certificate)</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/AWS/">AWS</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-12-22T05:29:29.000Z">2019-12-22</time></div>
                    <a href="/2019/12/22/unit-test-express-implement-troubleshooting/" class="title has-link-black-ter is-size-6 has-text-weight-normal">express unit test 一些技巧教學以及困難點</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Test/">Test</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-12-10T15:02:14.000Z">2019-12-10</time></div>
                    <a href="/2019/12/10/unit-test-express/" class="title has-link-black-ter is-size-6 has-text-weight-normal">unit test 是什麼? 又該如何在 express 開發上實作 unit test?</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Test/">Test</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>
        
        </div>
    
</div>


                





<div class="column is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only has-order-3 column-right ">
    
        <div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-01-08T16:30:25.000Z">2020-01-09</time></div>
                    <a href="/2020/01/09/express-get-client-ip-from-load-balancer/" class="title has-link-black-ter is-size-6 has-text-weight-normal">如何從多層 Load Balancer / Nginx 取得使用者正確的 IP?</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Security/">Security</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-01-06T15:10:13.000Z">2020-01-06</time></div>
                    <a href="/2020/01/06/aws-increase-disk-space-in-ec2/" class="title has-link-black-ter is-size-6 has-text-weight-normal">如何增加 EC2 硬碟大小 (Expand the disk space in EC2)</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/AWS/">AWS</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-01-06T02:16:52.000Z">2020-01-06</time></div>
                    <a href="/2020/01/06/aws-certificate-manager/" class="title has-link-black-ter is-size-6 has-text-weight-normal">AWS Certificate Manager 如何更換憑證 (Reimport Certificate)</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/AWS/">AWS</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-12-22T05:29:29.000Z">2019-12-22</time></div>
                    <a href="/2019/12/22/unit-test-express-implement-troubleshooting/" class="title has-link-black-ter is-size-6 has-text-weight-normal">express unit test 一些技巧教學以及困難點</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Test/">Test</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-12-10T15:02:14.000Z">2019-12-10</time></div>
                    <a href="/2019/12/10/unit-test-express/" class="title has-link-black-ter is-size-6 has-text-weight-normal">unit test 是什麼? 又該如何在 express 開發上實作 unit test?</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Test/">Test</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>
    
    
</div>


            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <p class="is-size-7">
                &copy; 2020 Jack Yu&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a> & Jack Yu
                
                </p>
            </div>
            <div class="level-end">
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-TW");</script>


<script>
var IcarusThemeSettings = {
    site: {
        url: 'https://yu-jack.github.io',
        external_link: {"enable":true,"exclude":[]}
    },
    article: {
        highlight: {
            clipboard: true,
            fold: 'unfolded'
        }
    }
};
</script>


<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>





<script src="/js/animation.js"></script>



<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
<script src="/js/gallery.js" defer></script>



<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>


<a id="back-to-top" title="回到頁首" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>














<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="請輸入關鍵字..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '頁面',
                CATEGORIES: '分類',
                TAGS: '標籤',
                UNTITLED: '(無標題)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</body>
</html>